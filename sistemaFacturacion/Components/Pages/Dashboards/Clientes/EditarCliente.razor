@page "/dashboards/clientes/editar"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]

<div class="page-header mb-3">
    <h2 class="page-title fs-18">Editar Cliente</h2>
    <p class="text-muted">Busca por Identificación/RUC y actualiza datos permitidos.</p>
</div>

<!-- Buscador -->
<div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4 col-12">
                <label class="form-label">Tipo de identificación</label>
                <InputSelect class="form-select" @bind-Value="search.Tipo">
                    <option value="">-- Selecciona --</option>
                    <option value="Cedula">Cédula</option>
                    <option value="RUC">RUC</option>
                    <option value="Pasaporte">Pasaporte</option>
                </InputSelect>
            </div>
            <div class="col-md-6 col-12">
                <label class="form-label">Identificación / RUC</label>
                <InputText class="form-control" @bind-Value="search.Identificacion" placeholder="Ej: 0102030405 / 17900...001" />
            </div>
            <div class="col-md-2 d-grid col-12">
                <button class="btn btn-primary" @onclick="BuscarCliente">Buscar</button>
            </div>
        </div>

        @if (searchError is not null)
        {
            <div class="alert alert-danger mt-3 mb-0">
                @searchError
            </div>
        }
    </div>
</div>

@if (cargando)
{
    <div class="alert alert-info">Buscando cliente...</div>
}
else if (form is not null)
{
    <!-- Resumen del cliente -->
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-between flex-wrap">
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-primary-subtle p-3">
                    <i class="ri-user-3-line fs-4"></i>
                </div>
                <div>
                    <h5 class="mb-0">@form.Nombre @form.Apellido</h5>
                    <small class="text-muted">
                        @form.TipoIdentificacion: <strong>@form.Identificacion</strong>
                    </small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <span class="badge text-bg-success">Activo</span>
                <span class="badge text-bg-light">Clientes</span>
            </div>
        </div>
    </div>

    <!-- Formulario de edición -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="@form" OnValidSubmit="@HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <!-- Identificación (bloqueada) -->
                <div class="row g-3">
                    <div class="col-md-4 col-12">
                        <label class="form-label">Tipo de identificación</label>
                        <InputText class="form-control" @bind-Value="form.TipoIdentificacion" readonly />
                        <small class="text-muted">Campo no editable.</small>
                    </div>
                    <div class="col-md-8 col-12">
                        <label class="form-label">Identificación / RUC</label>
                        <InputText class="form-control" @bind-Value="form.Identificacion" readonly />
                        <small class="text-muted">Campo no editable.</small>
                    </div>
                </div>

                <hr class="my-4" />

                <!-- Datos personales -->
                <div class="row g-3">
                    <div class="col-md-6 col-12">
                        <label class="form-label">Nombre</label>
                        <InputText class="form-control" @bind-Value="form.Nombre" />
                        <ValidationMessage For="@(() => form.Nombre)" />
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="form-label">Apellido</label>
                        <InputText class="form-control" @bind-Value="form.Apellido" />
                        <ValidationMessage For="@(() => form.Apellido)" />
                    </div>
                </div>

                <!-- Contacto -->
                <div class="row g-3 mt-1">
                    <div class="col-12">
                        <label class="form-label">Dirección</label>
                        <InputText class="form-control" @bind-Value="form.Direccion" />
                        <ValidationMessage For="@(() => form.Direccion)" />
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="form-label">Teléfono</label>
                        <InputText class="form-control" @bind-Value="form.Telefono" inputmode="tel" />
                        <ValidationMessage For="@(() => form.Telefono)" />
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="form-label">Correo electrónico</label>
                        <InputText class="form-control" @bind-Value="form.Correo" type="email" />
                        <ValidationMessage For="@(() => form.Correo)" />
                    </div>
                </div>

                <!-- Acciones -->
                <div class="d-flex mt-4 gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@guardando">
                        @(guardando ? "Guardando..." : "Guardar cambios")
                    </button>
                    <a class="btn btn-light" href="/dashboards/clientes">Volver</a>
                </div>
            </EditForm>
        </div>
    </div>
}
else if (yaBusco)
{
    <div class="alert alert-warning">No se encontró un cliente con esos datos.</div>
}

@code {
    // --- ViewModel para edición (sin editar identificación) ---
    public class ClienteEditVM
    {
        // No editables
        public string? TipoIdentificacion { get; set; }
        public string? Identificacion { get; set; }

        // Editables
        [Required(ErrorMessage = "El nombre es obligatorio.")]
        [RegularExpression(@"^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$", ErrorMessage = "Solo letras y espacios.")]
        [StringLength(80)]
        public string? Nombre { get; set; }

        [Required(ErrorMessage = "El apellido es obligatorio.")]
        [RegularExpression(@"^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$", ErrorMessage = "Solo letras y espacios.")]
        [StringLength(80)]
        public string? Apellido { get; set; }

        [Required(ErrorMessage = "La dirección es obligatoria.")]
        [StringLength(150)]
        public string? Direccion { get; set; }

        [Required(ErrorMessage = "El teléfono es obligatorio.")]
        [RegularExpression(@"^\d{7,15}$", ErrorMessage = "Entre 7 y 15 dígitos.")]
        public string? Telefono { get; set; }

        [Required(ErrorMessage = "El correo es obligatorio.")]
        [EmailAddress(ErrorMessage = "Correo inválido.")]
        public string? Correo { get; set; }
    }

    // --- Modelo para búsqueda ---
    private class SearchVM
    {
        public string? Tipo { get; set; }
        public string? Identificacion { get; set; }
    }

    private SearchVM search = new();
    private ClienteEditVM? form;
    private string? searchError;
    private bool cargando = false;
    private bool guardando = false;
    private bool yaBusco = false;

    private async Task BuscarCliente()
    {
        searchError = null;
        cargando = true;
        yaBusco = true;
        form = null;

        // Validaciones mínimas del buscador
        if (string.IsNullOrWhiteSpace(search.Tipo) || string.IsNullOrWhiteSpace(search.Identificacion))
        {
            searchError = "Selecciona el tipo y escribe la identificación.";
            cargando = false;
            StateHasChanged();
            return;
        }

        try
        {
            // TODO: Reemplazar por llamada a tu servicio/API
            await Task.Delay(400); // Simula latencia
            var cliente = DemoRepo.FirstOrDefault(x =>
                x.TipoIdentificacion.Equals(search.Tipo, StringComparison.OrdinalIgnoreCase) &&
                x.Identificacion == search.Identificacion.Trim());

            if (cliente is null)
            {
                form = null;
            }
            else
            {
                form = new ClienteEditVM
                {
                    TipoIdentificacion = cliente.TipoIdentificacion,
                    Identificacion = cliente.Identificacion,
                    Nombre = cliente.Nombre,
                    Apellido = cliente.Apellido,
                    Direccion = cliente.Direccion,
                    Telefono = cliente.Telefono,
                    Correo = cliente.Correo
                };
            }
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        guardando = true;
        try
        {
            // TODO: Llamar a tu API para actualizar.
            await Task.Delay(400); // Simula persistencia
            Console.WriteLine($"Actualizado: {form?.Nombre} {form?.Apellido}");
            // Aquí puedes disparar un toast/alert de éxito.
        }
        finally
        {
            guardando = false;
        }
    }

    // --- Repositorio Mock (sólo demo visual) ---
    private record ClienteDemo(
        string TipoIdentificacion,
        string Identificacion,
        string Nombre,
        string Apellido,
        string Direccion,
        string Telefono,
        string Correo
    );

    private static readonly List<ClienteDemo> DemoRepo = new()
    {
        new("Cedula","0102030405","María","Zapata","Calle A 123","0999999999","maria@demo.com"),
        new("RUC","1790012345001","Erick","Guerrón","Av. B 555","0988888888","erick@demo.com"),
        new("Cedula","1104685321","Xabier","Pérez","Pasaje C 777","0977777777","xperez@demo.com"),
    };
}
