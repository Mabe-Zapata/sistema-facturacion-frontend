@page "/dashboards/clientes/editar"
@using System.ComponentModel.DataAnnotations
@using CurrieTechnologies.Razor.SweetAlert2
@using Microsoft.AspNetCore.Authorization
@using sistemaFacturacion
@inject IClientesApiClient ClientesApi
@inject SweetAlertService Swal
@attribute [Authorize]

<div class="page-header mb-3">
    <h2 class="page-title fs-18">Editar Cliente</h2>
    <p class="text-muted">Busca por Identificación/RUC y actualiza datos permitidos.</p>
</div>

<div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4 col-12">
                <label class="form-label">Tipo de identificación</label>
                <InputSelect class="form-select" @bind-Value="search.Tipo">
                    <option value="">-- Selecciona --</option>
                    <option value="Cedula">Cédula</option>
                    <option value="RUC">RUC</option>
                    <option value="Pasaporte">Pasaporte</option>
                </InputSelect>
            </div>
            <div class="col-md-6 col-12">
                <label class="form-label">Identificación / RUC</label>
                <InputText class="form-control" @bind-Value="search.Identificacion" placeholder="Ej: 0102030405 / 17900...001" />
            </div>
            <div class="col-md-2 d-grid col-12">
                <button class="btn btn-primary" @onclick="BuscarCliente" disabled="@cargando">
                    @(cargando ? "Buscando..." : "Buscar")
                </button>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(searchError))
        {
            <div class="alert alert-danger mb-0 mt-3">@searchError</div>
        }
    </div>
</div>

@if (cargando)
{
    <div class="alert alert-info">Buscando cliente...</div>
}
else if (form is not null)
{
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body d-flex align-items-center justify-content-between flex-wrap">
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-primary-subtle p-3">
                    <i class="ri-user-3-line fs-4"></i>
                </div>
                <div>
                    <h5 class="mb-0">@form.Nombre @form.Apellido</h5>
                    <small class="text-muted">
                        @form.TipoIdentificacion: <strong>@form.Identificacion</strong>
                    </small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <span class="badge text-bg-success">Activo</span>
                <span class="badge text-bg-light">Clientes</span>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="@form" OnValidSubmit="@HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-3">
                    <div class="col-md-4 col-12">
                        <label class="form-label">Tipo de identificación</label>
                        <InputText class="form-control" @bind-Value="form.TipoIdentificacion" readonly />
                        <small class="text-muted">Campo no editable.</small>
                    </div>
                    <div class="col-md-8 col-12">
                        <label class="form-label">Identificación / RUC</label>
                        <InputText class="form-control" @bind-Value="form.Identificacion" readonly />
                        <small class="text-muted">Campo no editable.</small>
                    </div>
                </div>

                <hr class="my-4" />

                <div class="row g-3">
                    <div class="col-md-6 col-12">
                        <label class="form-label">Nombre</label>
                        <InputText class="form-control" @bind-Value="form.Nombre" />
                        <ValidationMessage For="@(() => form.Nombre)" />
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="form-label">Apellido</label>
                        <InputText class="form-control" @bind-Value="form.Apellido" />
                        <ValidationMessage For="@(() => form.Apellido)" />
                    </div>
                </div>

                <div class="row g-3 mt-1">
                    <div class="col-12">
                        <label class="form-label">Dirección</label>
                        <InputText class="form-control" @bind-Value="form.Direccion" />
                        <ValidationMessage For="@(() => form.Direccion)" />
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="form-label">Teléfono</label>
                        <InputText class="form-control" @bind-Value="form.Telefono" inputmode="tel" />
                        <ValidationMessage For="@(() => form.Telefono)" />
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="form-label">Correo electrónico</label>
                        <InputText class="form-control" @bind-Value="form.Correo" type="email" />
                        <ValidationMessage For="@(() => form.Correo)" />
                    </div>
                </div>

                <div class="d-flex mt-4 gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@guardando">
                        @(guardando ? "Guardando..." : "Guardar cambios")
                    </button>
                    <a class="btn btn-light" href="/dashboards/clientes">Volver</a>
                </div>
            </EditForm>
        </div>
    </div>
}
else if (yaBusco)
{
    <div class="alert alert-warning">No se encontró un cliente con esos datos.</div>
}

@code {
    public class ClienteEditVM
    {
        // Sólo lectura en UI
        public string? TipoIdentificacion { get; set; }  // tipCli
        public string? Identificacion { get; set; }      // ideCli

        // Editables
        [Required, RegularExpression(@"^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$"), StringLength(80)]
        public string? Nombre { get; set; }              // nomCli

        [Required, RegularExpression(@"^[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+$"), StringLength(80)]
        public string? Apellido { get; set; }            // apeCli

        [Required, StringLength(150)]
        public string? Direccion { get; set; }           // dirCli

        [Required, RegularExpression(@"^\d{7,15}$")]
        public string? Telefono { get; set; }            // telCli

        [Required, EmailAddress]
        public string? Correo { get; set; }              // corCli
    }

    private class SearchVM { public string? Tipo { get; set; } public string? Identificacion { get; set; } }

    private SearchVM search = new();
    private ClienteEditVM? form;
    private string? searchError;
    private bool cargando = false;
    private bool guardando = false;
    private bool yaBusco = false;
    private int? clienteId; // idCli para PUT

    private async Task BuscarCliente()
    {
        searchError = null;
        cargando = true;
        yaBusco = true;
        form = null;
        clienteId = null;
        StateHasChanged();

        if (string.IsNullOrWhiteSpace(search.Tipo) || string.IsNullOrWhiteSpace(search.Identificacion))
        {
            searchError = "Selecciona el tipo y escribe la identificación.";
            cargando = false;
            return;
        }

        search.Identificacion = new string(search.Identificacion.Where(char.IsDigit).ToArray());

        try
        {
            var cliente = await ClientesApi.GetByDocumentoAsync(search.Tipo!, search.Identificacion!);

            if (cliente is null)
            {

                string nTipo = (search.Tipo ?? "").Trim().ToUpperInvariant();
                string nDoc = new string((search.Identificacion ?? "").Where(char.IsDigit).ToArray());

                var all = await ClientesApi.GetAllAsync();
                var sugerencias = all
                    .Where(c =>
                        string.Equals((c.TipCli ?? "").Trim(), nTipo, StringComparison.OrdinalIgnoreCase) &&
                        new string((c.IdeCli ?? "").Where(char.IsDigit).ToArray()).StartsWith(nDoc)
                    )
                    .Take(5)
                    .ToList();

                if (sugerencias.Count == 0)
                {
                    await Swal.FireAsync(new SweetAlertOptions
                    {
                        Title = "Sin resultados",
                        Text = "No se encontró un cliente con esos datos.",
                        Icon = SweetAlertIcon.Warning
                    });
                    return;
                }

                var html = string.Join("<br/>",
                    sugerencias.Select(s => $"{s.NomCli} {s.ApeCli} — {s.IdeCli}"));

                await Swal.FireAsync(new SweetAlertOptions
                {
                    Title = "¿Quisiste decir?",
                    Html = html,
                    Icon = SweetAlertIcon.Info
                });

                return;
            }

            clienteId = cliente.IdCli;
            form = new ClienteEditVM
            {
                TipoIdentificacion = cliente.TipCli,
                Identificacion = cliente.IdeCli,
                Nombre = cliente.NomCli,
                Apellido = cliente.ApeCli,
                Direccion = cliente.DirCli,
                Telefono = cliente.TelCli,
                Correo = cliente.CorCli
            };

            await Swal.FireAsync(new SweetAlertOptions
            {
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Success,
                Title = "Cliente cargado",
                ShowConfirmButton = false,
                Timer = 1200
            });
        }
        catch (HttpRequestException ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Error al buscar",
                Html = $"<small>{ex.Message}</small>",
                Icon = SweetAlertIcon.Error
            });
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private async Task HandleValidSubmit()
    {
        if (clienteId is null) return;

        var confirm = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Guardar cambios?",
            Text = "Se actualizarán los datos de contacto del cliente.",
            Icon = SweetAlertIcon.Question,
            ShowCancelButton = true,
            ConfirmButtonText = "Sí, guardar",
            CancelButtonText = "Cancelar"
        });
        if (!confirm.IsConfirmed) return;

        guardando = true;

        try
        {
            // El API espera: direccion, telefono, correoElectronico
            var payload = new ClienteContactoUpdate
            {
                Direccion = form!.Direccion!,
                Telefono = form!.Telefono!,
                CorreoElectronico = form!.Correo!
            };

            await ClientesApi.UpdateContactoAsync(clienteId.Value, payload);

            await Swal.FireAsync(new SweetAlertOptions
            {
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Success,
                Title = "Cambios guardados",
                ShowConfirmButton = false,
                Timer = 1500
            });
        }
        catch (HttpRequestException ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "No se pudo guardar",
                Html = $"<small>{ex.Message}</small>",
                Icon = SweetAlertIcon.Error
            });
        }
        finally
        {
            guardando = false;
        }
    }
}
