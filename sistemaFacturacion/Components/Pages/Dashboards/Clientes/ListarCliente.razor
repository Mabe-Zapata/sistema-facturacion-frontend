@page "/dashboards/clientes/listar"
@using ApexCharts
@using Microsoft.AspNetCore.Authorization
@using CurrieTechnologies.Razor.SweetAlert2
@attribute [Authorize]
@inject IJSRuntime JSRuntime
@inject IClientesApiClient ClientesApi
@inject NavigationManager Navigation
@inject SweetAlertService Swal

<div class="page-header mb-3">
  <h2 class="page-title fs-18">Listado de Clientes</h2>
  <p class="text-muted">Búsqueda, filtros, tabla paginada y métricas rápidas.</p>
</div>

@if (cargando)
{
  <div class="alert alert-info">
    <span class="spinner-border spinner-border-sm me-2"></span>
    Cargando clientes...
  </div>
}
else if (!string.IsNullOrWhiteSpace(error))
{
  <div class="alert alert-danger">
    <i class="ri-error-warning-line me-2"></i>@error
  </div>
}
else
{
  <div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3 col-12">
          <label class="form-label">Buscar (nombre, apellido, identificación, correo, teléfono)</label>
          <input class="form-control" @bind="filtroTexto" @bind:event="oninput" placeholder="Escribe para filtrar..." />
        </div>
        <div class="col-md-2 col-6">
          <label class="form-label">Tipo de identificación</label>
          <select class="form-select" @bind="filtroTipo">
            <option value="">Todos</option>
            <option value="CEDULA">Cédula</option>
            <option value="RUC">RUC</option>
            <option value="PASAPORTE">Pasaporte</option>
          </select>
        </div>
        <div class="col-md-2 col-6">
          <label class="form-label">Ordenar por fecha</label>
          <select class="form-select" @bind="ordenFecha">
            <option value="">Sin orden</option>
            <option value="recientes">Más recientes</option>
            <option value="antiguos">Más antiguos</option>
          </select>
        </div>
        <div class="col-md-2 col-6">
          <label class="form-label">Estado</label>
          <select class="form-select" @bind="filtroEstado">
            <option value="">Todos</option>
            <option value="activos">Activos</option>
            <option value="inactivos">Inactivos</option>
          </select>
        </div>
        <div class="col-md-1 col-6">
          <label class="form-label">Por página</label>
          <select class="form-select" @bind="pageSize">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>
        <div class="col-md-2 d-grid col-12">
          <button class="btn btn-outline-secondary" @onclick="LimpiarFiltros">
            <i class="ri-filter-off-line me-1"></i> Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 metrics mb-3">
    <div class="col-xl-3 col-md-6 col-12">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="text-muted fs-12">Total (filtrado)</div>
          <div class="fs-3 fw-semibold">@FilteredCount</div>
          <small class="text-muted">de @totalClientes clientes</small>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 col-12">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="text-muted fs-12">Cédula</div>
          <div class="fs-3 fw-semibold">@CountBy("CEDULA")</div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 col-12">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="text-muted fs-12">RUC</div>
          <div class="fs-3 fw-semibold">@CountBy("RUC")</div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 col-12">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-body">
          <div class="text-muted fs-12">Pasaporte</div>
          <div class="fs-3 fw-semibold">@CountBy("PASAPORTE")</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-lg-6 col-12">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-header bg-transparent"><h6 class="mb-0">Clientes por Tipo de Identificación</h6></div>
        <div class="card-body">
          <ApexChart TItem="ChartSlice" Title="Distribución de Tipos" ChartType="ChartType.Donut" Height="260">
            <ApexPointSeries TItem="ChartSlice" Items="DonutData" Name="Clientes" XValue="@(x => x.Label)" YValue="@(x => x.Value)" />
            <ApexChartLegend Position="LegendPosition.Bottom" />
          </ApexChart>
        </div>
      </div>
    </div>
    <div class="col-lg-6 col-12">
      <div class="card h-100 border-0 shadow-sm">
        <div class="card-header bg-transparent"><h6 class="mb-0">Top 5 Dominios de Correo</h6></div>
        <div class="card-body">
          <ApexChart TItem="ChartSlice" Title="Dominios Más Usados" ChartType="ChartType.Bar" Height="260">
            <ApexPointSeries TItem="ChartSlice" Items="BarData" Name="Clientes" XValue="@(x => x.Label)" YValue="@(x => x.Value)" />
            <ApexChartLegend Position="LegendPosition.Bottom" />
          </ApexChart>
        </div>
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-header d-flex align-items-center justify-content-between bg-transparent">
      <h6 class="mb-0">Clientes (@FilteredCount resultados)</h6>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-light" title="Recargar" @onclick="RecargarDatos"><i class="ri-refresh-line"></i></button>
        <button class="btn btn-sm btn-light" title="Anterior" @onclick="PrevPage" disabled="@(pageIndex==1)"><i class="ri-arrow-left-s-line"></i></button>
        <span class="small text-muted">Página @pageIndex de @TotalPages</span>
        <button class="btn btn-sm btn-light" title="Siguiente" @onclick="NextPage" disabled="@(pageIndex==TotalPages)"><i class="ri-arrow-right-s-line"></i></button>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table-hover mb-0 table align-middle">
          <thead class="text-muted">
            <tr>
              <th @onclick="@(()=>OrdenarPor(nameof(ClienteDto.NomCli)))" role="button" class="user-select-none">Nombre @IconoOrden(nameof(ClienteDto.NomCli))</th>
              <th @onclick="@(()=>OrdenarPor(nameof(ClienteDto.ApeCli)))" role="button" class="user-select-none">Apellido @IconoOrden(nameof(ClienteDto.ApeCli))</th>
              <th @onclick="@(()=>OrdenarPor(nameof(ClienteDto.IdeCli)))" role="button" class="user-select-none">Identificación @IconoOrden(nameof(ClienteDto.IdeCli))</th>
              <th @onclick="@(()=>OrdenarPor(nameof(ClienteDto.TipCli)))" role="button" class="user-select-none">Tipo @IconoOrden(nameof(ClienteDto.TipCli))</th>
              <th>Dirección</th>
              <th>Teléfono</th>
              <th @onclick="@(()=>OrdenarPor(nameof(ClienteDto.CorCli)))" role="button" class="user-select-none">Correo @IconoOrden(nameof(ClienteDto.CorCli))</th>
              <th @onclick="@(()=>OrdenarPor(nameof(ClienteDto.FecCli)))" role="button" class="user-select-none">Fecha Registro @IconoOrden(nameof(ClienteDto.FecCli))</th>
              <th>Estado</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @if (Paged.Count == 0)
            {
              <tr><td colspan="10" class="text-muted py-4 text-center"><i class="ri-inbox-line fs-3 d-block mb-2"></i>No hay resultados con los filtros aplicados.</td></tr>
            }
            else
            {
              @foreach (var c in Paged)
              {
                <tr @key="c.IdCli">
                  <td>@c.NomCli</td>
                  <td>@c.ApeCli</td>
                  <td><code>@c.IdeCli</code></td>
                  <td><span class="badge bg-@GetTipoBadgeColor(c.TipCli)-subtle text-@GetTipoBadgeColor(c.TipCli)">@MostrarTipo(c.TipCli)</span></td>
                  <td><small class="text-muted">@c.DirCli</small></td>
                  <td><small>@c.TelCli</small></td>
                  <td><small>@c.CorCli</small></td>
                  <td><small class="text-muted">@c.FecCli.ToString("dd/MM/yyyy")</small></td>
                  <td>
                    @if (c.EstCli)
                    { <span class="badge bg-success-subtle text-success"><i class="ri-check-line"></i> Activo</span> }
                    else
                    { <span class="badge bg-danger-subtle text-danger"><i class="ri-close-line"></i> Inactivo</span> }
                  </td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => IrAEditar(c)" title="Editar cliente"><i class="ri-edit-line"></i></button>
                    <button class="btn btn-sm btn-outline-info me-1" @onclick="() => VerDetalles(c)" title="Ver detalles"><i class="ri-eye-line"></i></button>
                    <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmarEliminar(c)" title="Eliminar cliente"><i class="ri-delete-bin-line"></i></button>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
}

@code {
    private List<ClienteDto> clientes = new();
    private int totalClientes = 0;
    private bool cargando = true;
    private string? error;

    private string? filtroTexto;
    private string? filtroTipo;
    private string? filtroEstado;
    private string? ordenFecha;

    private int pageIndex = 1;

    private int _pageSize = 10;
    private int pageSize
    {
        get => _pageSize;
        set
        {
            if (_pageSize != value)
            {
                _pageSize = value;
                pageIndex = 1; // 🔧 evita @onchange duplicado con @bind
            }
        }
    }

    private string? sortBy;
    private bool sortAsc = true;

    protected override async Task OnInitializedAsync() => await CargarClientes();

    private async Task CargarClientes()
    {
        try
        {
            cargando = true; error = null;
            clientes = await ClientesApi.GetAllAsync();
            totalClientes = clientes.Count;
            bool isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
            if (isDark)
            {
                await Swal.FireAsync(new SweetAlertOptions
                {
                    Toast = true,
                    Position = SweetAlertPosition.TopEnd,
                    Icon = SweetAlertIcon.Success,
                    Title = $"✓ {totalClientes} clientes cargados",
                    ShowConfirmButton = false,
                    Timer = 2000,
                    TimerProgressBar = true,
                    Background = "#1e1e1e", 
                    Color = "#e6e6e6"
                });
            }else
            {
                await Swal.FireAsync(new SweetAlertOptions
                {
                    Toast = true,
                    Position = SweetAlertPosition.TopEnd,
                    Icon = SweetAlertIcon.Success,
                    Title = $"✓ {totalClientes} clientes cargados",
                    ShowConfirmButton = false,
                    Timer = 2000,
                    TimerProgressBar = true,
                });
            }

    }
    catch (HttpRequestException ex)
    {
      error = $"Error al cargar clientes: {ex.Message}";
      await Swal.FireAsync(new SweetAlertOptions { Title = "Error al cargar", Html = $"<small>{ex.Message}</small>", Icon = SweetAlertIcon.Error, ConfirmButtonText = "Entendido" });
    }
    finally { cargando = false; }
  }

  private async Task RecargarDatos()
  {     
        bool isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
        if (isDark)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Info,
                Title = "Recargando datos...",
                ShowConfirmButton = false,
                Timer = 1000,
                Background = "#1e1e1e",
                Color = "#e6e6e6"
            });
        }
        else
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Info,
                Title = "Recargando datos...",
                ShowConfirmButton = false,
                Timer = 1000
            });
        }
    await CargarClientes();
  }

  private List<ClienteDto> Filtered
  {
    get
    {
      var r = clientes.AsEnumerable();
      if (!string.IsNullOrWhiteSpace(filtroTexto))
      {
        var q = filtroTexto.Trim().ToLower();
        r = r.Where(c =>
          (c.NomCli?.ToLower().Contains(q) ?? false) ||
          (c.ApeCli?.ToLower().Contains(q) ?? false) ||
          (c.IdeCli?.ToLower().Contains(q) ?? false) ||
          (c.CorCli?.ToLower().Contains(q) ?? false) ||
          (c.TelCli?.ToLower().Contains(q) ?? false));
      }
      if (!string.IsNullOrWhiteSpace(filtroTipo))
        r = r.Where(c => c.TipCli?.Equals(filtroTipo, StringComparison.OrdinalIgnoreCase) ?? false);
      if (!string.IsNullOrWhiteSpace(filtroEstado))
      {
        var activo = filtroEstado == "activos";
        r = r.Where(c => c.EstCli == activo);
      }
      r = Ordenar(r);
      return r.ToList();
    }
  }

  private int FilteredCount => Filtered.Count;
  private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredCount / (double)pageSize));
  private List<ClienteDto> Paged => Filtered.Skip((pageIndex - 1) * pageSize).Take(pageSize).ToList();

  private IEnumerable<ClienteDto> Ordenar(IEnumerable<ClienteDto> src)
  {
    if (!string.IsNullOrWhiteSpace(ordenFecha))
      src = ordenFecha == "recientes" ? src.OrderByDescending(c => c.FecCli) : src.OrderBy(c => c.FecCli);

    if (!string.IsNullOrWhiteSpace(sortBy))
    {
      Func<ClienteDto, object?> key = sortBy switch
      {
        nameof(ClienteDto.NomCli) => c => c.NomCli ?? "",
        nameof(ClienteDto.ApeCli) => c => c.ApeCli ?? "",
        nameof(ClienteDto.IdeCli) => c => c.IdeCli ?? "",
        nameof(ClienteDto.TipCli) => c => c.TipCli ?? "",
        nameof(ClienteDto.CorCli) => c => c.CorCli ?? "",
        nameof(ClienteDto.FecCli) => c => c.FecCli,
        _ => c => c.NomCli ?? ""
      };
      src = sortAsc ? src.OrderBy(key) : src.OrderByDescending(key);
    }
    return src;
  }

  private void OrdenarPor(string prop)
  {
    if (sortBy == prop) sortAsc = !sortAsc;
    else { sortBy = prop; sortAsc = true; }
    pageIndex = 1;
  }

  private string IconoOrden(string prop) => sortBy != prop ? "" : (sortAsc ? "↑" : "↓");
  private void LimpiarFiltros() { filtroTexto = filtroTipo = filtroEstado = ordenFecha = null; sortBy = null; sortAsc = true; pageIndex = 1; Swal.FireAsync(new SweetAlertOptions { Toast = true, Position = SweetAlertPosition.TopEnd, Icon = SweetAlertIcon.Info, Title = "Filtros limpiados", ShowConfirmButton = false, Timer = 1500 }); }
  private void PrevPage() { if (pageIndex > 1) pageIndex--; }
  private void NextPage() { if (pageIndex < TotalPages) pageIndex++; }

  private async Task IrAEditar(ClienteDto c)
  {
    if (c == null || (c.IdCli <= 0))
    {
      await Swal.FireAsync(new SweetAlertOptions { Title = "ID inválido", Text = "El registro no tiene un identificador válido.", Icon = SweetAlertIcon.Warning });
      return;
    }
    Navigation.NavigateTo($"/dashboards/clientes/editar/{c.IdCli}");
  }

  private async Task VerDetalles(ClienteDto c)
  {
    await Swal.FireAsync(new SweetAlertOptions
    {
      Title = $"{c.NomCli} {c.ApeCli}",
      Html = $@"<div class='text-start'>
                  <p><strong>Identificación:</strong> {c.IdeCli} ({MostrarTipo(c.TipCli)})</p>
                  <p><strong>Dirección:</strong> {c.DirCli}</p>
                  <p><strong>Teléfono:</strong> {c.TelCli}</p>
                  <p><strong>Correo:</strong> {c.CorCli}</p>
                  <p><strong>Fecha de registro:</strong> {c.FecCli:dd/MM/yyyy HH:mm}</p>
                  <p><strong>Estado:</strong> {(c.EstCli ? true : false)}</p>
                </div>",
      Icon = SweetAlertIcon.Info,
      ConfirmButtonText = "Cerrar",
      Width = "600px"
    });
  }

  private async Task ConfirmarEliminar(ClienteDto c)
  {
    var r = await Swal.FireAsync(new SweetAlertOptions
    {
      Title = "¿Estás seguro?",
      Html = $"Se eliminará el cliente <strong>{c.NomCli} {c.ApeCli}</strong><br><small>({c.IdeCli})</small>",
      Icon = SweetAlertIcon.Warning,
      ShowCancelButton = true,
      ConfirmButtonText = "Sí, eliminar",
      CancelButtonText = "Cancelar",
      ConfirmButtonColor = "#dc3545",
      CancelButtonColor = "#6c757d"
    });
    if (r.IsConfirmed)
    {
      await Swal.FireAsync(new SweetAlertOptions { Title = "¡Eliminado!", Text = "El cliente ha sido eliminado exitosamente.", Icon = SweetAlertIcon.Success, Timer = 2000, ShowConfirmButton = false });
      await CargarClientes();
    }
  }

  private int CountBy(string tipo) => Filtered.Count(c => c.TipCli?.Equals(tipo, StringComparison.OrdinalIgnoreCase) ?? false);
  private static string MostrarTipo(string? tip) => (tip ?? "").Trim().ToUpperInvariant() switch
  {
    "CEDULA" => "Cédula",
    "RUC" => "RUC",
    "PASAPORTE" => "Pasaporte",
    _ => tip ?? ""
  };
  private static string GetTipoBadgeColor(string? tip) => (tip ?? "").Trim().ToUpperInvariant() switch
  {
    "CEDULA" => "primary",
    "RUC" => "success",
    "PASAPORTE" => "info",
    _ => "secondary"
  };

  private record ChartSlice(string Label, int Value);
  private List<ChartSlice> DonutData => new() { new("Cédula", CountBy("CEDULA")), new("RUC", CountBy("RUC")), new("Pasaporte", CountBy("PASAPORTE")) };
  private List<ChartSlice> BarData => Filtered.Where(c => !string.IsNullOrWhiteSpace(c.CorCli))
                                              .GroupBy(c => Dominio(c.CorCli!))
                                              .Select(g => new ChartSlice(g.Key, g.Count()))
                                              .OrderByDescending(x => x.Value)
                                              .Take(5).ToList();
  private static string Dominio(string correo) { var at = correo.IndexOf('@'); return at > 0 && at < correo.Length - 1 ? correo[(at + 1)..] : "(desconocido)"; }
}
