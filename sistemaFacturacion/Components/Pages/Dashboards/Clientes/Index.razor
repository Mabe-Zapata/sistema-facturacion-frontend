@page "/dashboards/clientes"
@using Microsoft.AspNetCore.Authorization
@using sistemaFacturacion.Models
@using CurrieTechnologies.Razor.SweetAlert2
@using ApexCharts
@attribute [Authorize]

@inject IClientesApiClient ClientesApi
@inject SweetAlertService Swal
@inject IJSRuntime JS
@inject NavigationManager Nav

<section class="clientes-dashboard">
    <div class="page-header mb-4">
        <h1 class="page-title fw-semibold fs-20">Gestión de Clientes</h1>
        <p class="text-muted fs-13">Panel general · accesos rápidos, KPIs y visualizaciones.</p>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3 mb-4">
        <div class="col">
            <a href="/dashboards/clientes/crear" class="text-decoration-none">
                <div class="card hover-scale h-100 border-0 shadow-sm">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="rounded-3 bg-primary-subtle p-3">
                            <i class="ri-user-add-line fs-3"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Crear cliente</h5>
                            <small class="text-muted">Registrar un nuevo cliente</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="/dashboards/clientes/editar" class="text-decoration-none">
                <div class="card hover-scale h-100 border-0 shadow-sm">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="rounded-3 bg-warning-subtle p-3">
                            <i class="ri-user-settings-line fs-3"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Editar cliente</h5>
                            <small class="text-muted">Actualizar datos existentes</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="/dashboards/clientes/listar" class="text-decoration-none">
                <div class="card hover-scale h-100 border-0 shadow-sm">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="rounded-3 bg-success-subtle p-3">
                            <i class="ri-file-list-3-line fs-3"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Listar clientes</h5>
                            <small class="text-muted">Búsqueda avanzada y filtros</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    @if (cargando)
    {
        <div class="alert alert-info">Cargando estadísticas...</div>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger">@error</div>
    }
    else
    {
        <div class="row g-3 mb-4">
            <div class="col-sm-6 col-xl-3 col-12">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="text-muted fs-12">Total clientes</div>
                        <div class="fs-3 fw-semibold">@totalClientes</div>
                        <div class="@totalTrendClass fs-12">@totalTrendText</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3 col-12">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="text-muted fs-12">Clientes activos</div>
                        <div class="fs-3 fw-semibold">@activos</div>
                        <div class="text-muted fs-12">@activosPctStr activos</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3 col-12">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="text-muted fs-12">Clientes nuevos (últimos 30 días)</div>
                        <div class="fs-3 fw-semibold">@nuevos30d</div>
                        <div class="@nuevosTrendClass fs-12">@nuevosTrendText</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3 col-12">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="text-muted fs-12">Clientes inactivos</div>
                        <div class="fs-3 fw-semibold">@inactivos</div>
                        <div class="text-muted fs-12">—</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-lg-5 col-12">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">Clientes por Tipo de Identificación</h6>
                    </div>
                    <div class="card-body">
                        @if (DonutData.Any())
                        {
                            <ApexChart TItem="ChartSlice"
                                       Title="Distribución de Tipos"
                                       Options="DonutOptions"
                                       @ref="DonutChart">
                                <ApexPointSeries TItem="ChartSlice"
                                                 Items="DonutData"
                                                 Name="Clientes"
                                                 SeriesType="SeriesType.Donut"
                                                 XValue="e => e.Label"
                                                 YValue="e => e.Value" />
                            </ApexChart>
                        }
                        else
                        {
                            <div class="text-muted small">Sin datos para mostrar.</div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-7 col-12">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">Top 5 Dominios de Correo</h6>
                    </div>
                    <div class="card-body">
                        @if (BarData.Any())
                        {
                            <ApexChart TItem="ChartSlice"
                                       Title="Dominios más usados"
                                       Options="BarOptions"
                                       @ref="BarChart">
                                <ApexPointSeries TItem="ChartSlice"
                                                 Items="BarData"
                                                 Name="Clientes"
                                                 SeriesType="SeriesType.Bar"
                                                 XValue="e => e.Label"
                                                 YValue="e => e.Value" />
                            </ApexChart>
                        }
                        else
                        {
                            <div class="text-muted small">Sin datos para mostrar.</div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-transparent">
                <h6 class="mb-0">Últimos clientes registrados</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="mb-0 table align-middle">
                        <thead class="text-muted">
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Apellido</th>
                                <th>Identificación/RUC</th>
                                <th>Tipo</th>
                                <th>Teléfono</th>
                                <th>Correo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ultimos5.Count == 0)
                            {
                                <tr>
                                    <td colspan="7" class="text-muted text-center">Sin registros recientes</td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var c in ultimos5)
                                {
                                    <tr>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(c.CodCli))
                                            {
                                                <span class="badge bg-primary-subtle text-primary fw-semibold">
                                                    @c.CodCli
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">—</span>
                                            }
                                        </td>
                                        <td>@c.NomCli</td>
                                        <td>@c.ApeCli</td>
                                        <td>@c.IdeCli</td>
                                        <td>@MostrarTipo(c.TipCli)</td>
                                        <td>@c.TelCli</td>
                                        <td>@c.CorCli</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-6 col-12">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">Acciones frecuentes</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled d-grid mb-0 gap-2">
                            <li><a class="link-primary" href="/dashboards/clientes/crear"><i class="bi bi-person-plus"></i> Registrar cliente</a></li>
                            <li><a class="link-primary" href="/dashboards/clientes/listar"><i class="bi bi-search"></i> Buscar por identificación</a></li>
                            <li><a class="link-primary" href="/dashboards/clientes/editar"><i class="bi bi-pencil"></i> Actualizar datos de contacto</a></li>
                            <li><a class="link-danger" href="/dashboards/clientes/eliminar"><i class="bi bi-trash"></i> Dar de baja</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-12">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">Notas</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-2">
                            Campos clave del cliente: <strong>Código, Nombre, Apellido, Identificación/RUC, Tipo de Identificación, Dirección, Teléfono, Correo</strong>.
                        </p>
                        <p class="text-muted mb-0">
                            KPIs y gráficos calculados desde el listado actual de clientes.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
</section>

@code {
    private List<ClienteDto> clientes = new();
    private List<ClienteDto> ultimos5 = new();
    private bool cargando = true;
    private string? error;

    private int totalClientes;
    private int activos;
    private int inactivos;
    private int nuevos30d;
    private string activosPctStr = "0%";
    private string totalTrendText = "—";
    private string totalTrendClass = "text-muted";
    private string nuevosTrendText = "—";
    private string nuevosTrendClass = "text-muted";

    private bool isDarkMode;

    private sealed class ChartSlice
    {
        public string Label { get; set; } = string.Empty;
        public int Value { get; set; }
    }

    private ApexChart<ChartSlice>? DonutChart;
    private List<ChartSlice> DonutData = new();
    private ApexChartOptions<ChartSlice> DonutOptions = new();

    private ApexChart<ChartSlice>? BarChart;
    private List<ChartSlice> BarData = new();
    private ApexChartOptions<ChartSlice> BarOptions = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Cargar();
        }
    }

    private async Task Cargar(bool toast = false)
    {
        try
        {
            cargando = true;
            StateHasChanged();

            isDarkMode = await JS.InvokeAsync<bool>("isAppInDarkMode");
            ConfigurarGraficos();

            clientes = await ClientesApi.GetAllAsync();
            CalcularKpisYRecientes();
            CalcularDatosGraficos();

            if (toast)
            {
                await Swal.FireAsync(new SweetAlertOptions
                {
                    Toast = true,
                    Position = SweetAlertPosition.TopEnd,
                    Icon = SweetAlertIcon.Success,
                    Title = $"Datos actualizados (@totalClientes)",
                    ShowConfirmButton = false,
                    Timer = 1200,
                    Background = isDarkMode ? "#1e1e1e" : null,
                    Color = isDarkMode ? "#e6e6e6" : null
                });
            }
        }
        catch (HttpRequestException ex)
        {
            error = $"No se pudieron cargar los clientes. {ex.Message}";
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Error al cargar",
                Html = $"<small>{ex.Message}</small>",
                Icon = SweetAlertIcon.Error
            });
        }
        finally
        {
            cargando = false;
            StateHasChanged();
        }
    }

    private void ConfigurarGraficos()
    {
        var textColor = isDarkMode ? "#ffffff" : "#373d3f";
        var labelColor = isDarkMode ? "#b0b0b0" : "#666666";

        DonutOptions = new ApexChartOptions<ChartSlice>
        {
            Chart = new Chart
            {
                Type = ChartType.Donut,
                Background = "transparent"
            },
            Legend = new Legend
            {
                Position = LegendPosition.Bottom,
                Labels = new LegendLabels
                {
                    Colors = textColor
                }
            },
            Theme = new Theme
            {
                Mode = isDarkMode ? Mode.Dark : Mode.Light
            },
            DataLabels = new DataLabels
            {
                Style = new DataLabelsStyle
                {
                    Colors = new List<string> { "#ffffff" }
                }
            }
        };

        BarOptions = new ApexChartOptions<ChartSlice>
        {
            Chart = new Chart
            {
                Type = ChartType.Bar,
                Background = "transparent"
            },
            PlotOptions = new PlotOptions
            {
                Bar = new PlotOptionsBar
                {
                    Horizontal = false,
                    ColumnWidth = "55%"
                }
            },
            DataLabels = new DataLabels { Enabled = false },
            Legend = new Legend
            {
                Position = LegendPosition.Top,
                Labels = new LegendLabels
                {
                    Colors = textColor
                }
            },
            Xaxis = new XAxis
            {
                Labels = new XAxisLabels
                {
                    Style = new AxisLabelStyle
                    {
                        Colors = labelColor
                    }
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Labels = new YAxisLabels
                    {
                        Style = new AxisLabelStyle
                        {
                            Colors = labelColor
                        }
                    }
                }
            },
            Theme = new Theme
            {
                Mode = isDarkMode ? Mode.Dark : Mode.Light
            }
        };
    }

    private void CalcularKpisYRecientes()
    {
        var now = DateTimeOffset.Now;
        var cutoff30 = now.AddDays(-30);
        var cutoff60 = now.AddDays(-60);

        totalClientes = clientes.Count;
        activos = clientes.Count(c => c.EstCli);
        inactivos = totalClientes - activos;

        activosPctStr = totalClientes > 0
            ? $"{Math.Round(activos * 100.0 / totalClientes, 1)}%"
            : "0%";

        nuevos30d = clientes.Count(c => (now - c.FecCli).TotalDays <= 30);

        var totalHace30 = clientes.Count(c => c.FecCli <= cutoff30);
        SetTrend(totalClientes, totalHace30, out totalTrendText, out totalTrendClass, "vs 30 días");

        var prev30 = clientes.Count(c => c.FecCli > cutoff60 && c.FecCli <= cutoff30);
        SetDelta(nuevos30d, prev30, out nuevosTrendText, out nuevosTrendClass);

        ultimos5 = clientes
            .OrderByDescending(c => c.FecCli)
            .ThenByDescending(c => c.IdCli)
            .Take(5)
            .ToList();
    }

    private void CalcularDatosGraficos()
    {
        DonutData = new List<ChartSlice>
        {
            new ChartSlice { Label = "Cédula", Value = CountByTipo("CEDULA") },
            new ChartSlice { Label = "RUC", Value = CountByTipo("RUC") },
            new ChartSlice { Label = "Pasaporte", Value = CountByTipo("PASAPORTE") }
        };

        BarData = clientes
            .Where(c => !string.IsNullOrWhiteSpace(c.CorCli))
            .GroupBy(c => Dominio(c.CorCli!))
            .Select(g => new ChartSlice { Label = g.Key, Value = g.Count() })
            .OrderByDescending(x => x.Value)
            .Take(5)
            .ToList();
    }

    private int CountByTipo(string tipo) =>
        clientes.Count(c => c.TipCli?.Equals(tipo, StringComparison.OrdinalIgnoreCase) ?? false);

    private static string Dominio(string correo)
    {
        var at = correo.IndexOf('@');
        return at > 0 && at < correo.Length - 1 ? correo[(at + 1)..] : "(desconocido)";
    }

    private static void SetTrend(int current, int baseline, out string text, out string css, string suffix)
    {
        if (baseline <= 0)
        {
            text = "—";
            css = "text-muted";
            return;
        }

        var pct = (current - baseline) * 100.0 / baseline;
        var sign = pct >= 0 ? "▲" : "▼";
        css = pct >= 0 ? "text-success" : "text-danger";
        text = $"{sign} {Math.Abs(Math.Round(pct, 1))}% {suffix}";
    }

    private static void SetDelta(int current, int previous, out string text, out string css)
    {
        var delta = current - previous;
        if (delta == 0)
        {
            text = "= sin cambio";
            css = "text-muted";
            return;
        }

        var sign = delta > 0 ? "▲" : "▼";
        css = delta > 0 ? "text-success" : "text-danger";
        text = $"{sign} {Math.Abs(delta)} vs 30d previos";
    }

    private static string MostrarTipo(string? tipCli)
    {
        var t = (tipCli ?? "").Trim().ToUpperInvariant();
        return t switch
        {
            "CEDULA" => "Cédula",
            "RUC" => "RUC",
            "PASAPORTE" => "Pasaporte",
            _ => tipCli ?? ""
        };
    }
}
