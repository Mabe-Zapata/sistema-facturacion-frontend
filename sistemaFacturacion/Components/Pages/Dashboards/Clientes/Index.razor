@page "/dashboards/clientes"
@using Microsoft.AspNetCore.Authorization
@using sistemaFacturacion
@using CurrieTechnologies.Razor.SweetAlert2
@using System.Linq
@attribute [Authorize]
@inject IClientesApiClient ClientesApi
@inject SweetAlertService Swal

<section class="clientes-dashboard">
    <div class="page-header mb-4">
        <h1 class="page-title fw-semibold fs-20">Gestión de Clientes</h1>
        <p class="text-muted fs-13">Panel general · accesos rápidos y actividad reciente</p>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3 mb-4">
        <div class="col">
            <a href="/dashboards/clientes/crear" class="text-decoration-none">
                <div class="card hover-scale h-100 border-0 shadow-sm">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="rounded-3 bg-primary-subtle p-3">
                            <i class="ri-user-add-line fs-3"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Crear cliente</h5>
                            <small class="text-muted">Registrar un nuevo cliente</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="/dashboards/clientes/editar" class="text-decoration-none">
                <div class="card hover-scale h-100 border-0 shadow-sm">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="rounded-3 bg-warning-subtle p-3">
                            <i class="ri-user-settings-line fs-3"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Editar cliente</h5>
                            <small class="text-muted">Actualizar datos existentes</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="/dashboards/clientes/listar" class="text-decoration-none">
                <div class="card hover-scale h-100 border-0 shadow-sm">
                    <div class="card-body d-flex align-items-center gap-3">
                        <div class="rounded-3 bg-success-subtle p-3">
                            <i class="ri-file-list-3-line fs-3"></i>
                        </div>
                        <div>
                            <h5 class="mb-1">Listar clientes</h5>
                            <small class="text-muted">Búsqueda y filtros</small>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    @if (cargando)
    {
        <div class="alert alert-info">Cargando estadísticas...</div>
    }
    else if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger">@error</div>
    }
    else
    {
        <div class="row g-3 mb-4">
            <div class="col-sm-6 col-xl-3 col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="text-muted fs-12">Total clientes</div>
                        <div class="fs-3 fw-semibold">@totalClientes</div>
                        <div class="@totalTrendClass fs-12">@totalTrendText</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3 col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="text-muted fs-12">Clientes activos</div>
                        <div class="fs-3 fw-semibold">@activos</div>
                        <div class="text-muted fs-12">@activosPctStr activos</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3 col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="text-muted fs-12">Clientes nuevos (últimos 30 días)</div>
                        <div class="fs-3 fw-semibold">@nuevos30d</div>
                        <div class="@nuevosTrendClass fs-12">@nuevosTrendText</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3 col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="text-muted fs-12">Clientes inactivos</div>
                        <div class="fs-3 fw-semibold">@inactivos</div>
                        <div class="text-muted fs-12">—</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-transparent">
                <h6 class="mb-0">Últimos clientes registrados</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="mb-0 table align-middle">
                        <thead class="text-muted">
                            <tr>
                                <th>Nombre</th>
                                <th>Apellido</th>
                                <th>Identificación/RUC</th>
                                <th>Tipo</th>
                                <th>Teléfono</th>
                                <th>Correo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ultimos5.Count == 0)
                            {
                                <tr><td colspan="6" class="text-muted text-center">Sin registros recientes</td></tr>
                            }
                            else
                            {
                                @foreach (var c in ultimos5)
                                {
                                    <tr>
                                        <td>@c.NomCli</td>
                                        <td>@c.ApeCli</td>
                                        <td>@c.IdeCli</td>
                                        <td>@MostrarTipo(c.TipCli)</td>
                                        <td>@c.TelCli</td>
                                        <td>@c.CorCli</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-lg-6 col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">Acciones frecuentes</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled d-grid mb-0 gap-2">
                            <li><a class="link-primary" href="/dashboards/clientes/crear">➕ Registrar cliente</a></li>
                            <li><a class="link-primary" href="/dashboards/clientes/listar">🔎 Buscar por identificación</a></li>
                            <li><a class="link-primary" href="/dashboards/clientes/editar">✏️ Actualizar datos de contacto</a></li>
                            <li><a class="link-danger" href="/dashboards/clientes/eliminar">🗑️ Dar de baja</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h6 class="mb-0">Notas</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-2">
                            Campos clave del cliente: <strong>Nombre, Apellido, Identificación/RUC, Tipo de Identificación, Dirección, Teléfono, Correo</strong>.
                        </p>
                        <p class="text-muted mb-0">KPIs calculados desde el listado actual.</p>
                    </div>
                </div>
            </div>
        </div>
    }
</section>

@code {
    private List<ClienteDto> clientes = new();
    private List<ClienteDto> ultimos5 = new();
    private bool cargando = true;
    private string? error;
    private int totalClientes;
    private int activos;
    private int inactivos;
    private int nuevos30d;
    private string activosPctStr = "0%";
    private string totalTrendText = "—";
    private string totalTrendClass = "text-muted";
    private string nuevosTrendText = "—";
    private string nuevosTrendClass = "text-muted";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            clientes = await ClientesApi.GetAllAsync();
            CalcularKpisYRecientes();
        }
        catch (HttpRequestException ex)
        {
            error = $"No se pudieron cargar los clientes. {ex.Message}";
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Error al cargar",
                Html = $"<small>{ex.Message}</small>",
                Icon = SweetAlertIcon.Error
            });
        }
        finally
        {
            cargando = false;
        }
    }

    private void CalcularKpisYRecientes()
    {
        var now = DateTimeOffset.Now;
        var cutoff30 = now.AddDays(-30);
        var cutoff60 = now.AddDays(-60);

        totalClientes = clientes.Count;
        activos = clientes.Count(c => c.EstCli);
        inactivos = totalClientes - activos;

        activosPctStr = totalClientes > 0
            ? $"{Math.Round(activos * 100.0 / totalClientes, 1)}%"
            : "0%";

        nuevos30d = clientes.Count(c => (now - c.FecCli).TotalDays <= 30);

        var totalHace30 = clientes.Count(c => c.FecCli <= cutoff30);
        SetTrend(totalClientes, totalHace30, out totalTrendText, out totalTrendClass, "vs 30 días");

        var prev30 = clientes.Count(c => c.FecCli > cutoff60 && c.FecCli <= cutoff30);
        SetDelta(nuevos30d, prev30, out nuevosTrendText, out nuevosTrendClass);

        ultimos5 = clientes
            .OrderByDescending(c => c.FecCli)
            .ThenByDescending(c => c.IdCli)
            .Take(5)
            .ToList();
    }

    private static void SetTrend(int current, int baseline, out string text, out string css, string suffix)
    {
        if (baseline <= 0)
        {
            text = "—";
            css = "text-muted";
            return;
        }
        var pct = (current - baseline) * 100.0 / baseline;
        var sign = pct >= 0 ? "▲" : "▼";
        css = pct >= 0 ? "text-success" : "text-danger";
        text = $"{sign} {Math.Abs(Math.Round(pct, 1))}% {suffix}";
    }

    private static void SetDelta(int current, int previous, out string text, out string css)
    {
        var delta = current - previous;
        if (delta == 0)
        {
            text = "= sin cambio";
            css = "text-muted";
            return;
        }
        var sign = delta > 0 ? "▲" : "▼";
        css = delta > 0 ? "text-success" : "text-danger";
        text = $"{sign} {Math.Abs(delta)} vs 30d previos";
    }

    private static string MostrarTipo(string? tipCli)
    {
        var t = (tipCli ?? "").Trim().ToUpperInvariant();
        return t switch
        {
            "CEDULA" => "Cédula",
            "RUC" => "RUC",
            "PASAPORTE" => "Pasaporte",
            _ => tipCli ?? ""
        };
    }
}
