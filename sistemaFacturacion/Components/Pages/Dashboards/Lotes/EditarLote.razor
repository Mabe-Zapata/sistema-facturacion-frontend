@page "/dashboards/lotes/editar/{id:int}"
@using System.ComponentModel.DataAnnotations
@using System.Net
@using Microsoft.AspNetCore.Authorization
@using sistemaFacturacion.Models
@using sistemaFacturacion.Services
@inject ILotesApiClient LotesApi
@inject IProductosApiClient ProductosApi
@inject NavigationManager Nav
@inject CurrieTechnologies.Razor.SweetAlert2.SweetAlertService Swal
@attribute [Authorize]

<h2 class="page-title fw-semibold fs-20 mb-2">Editar lote</h2>
<p class="text-muted mb-3">Actualiza los datos del lote y guarda los cambios.</p>

@if (isLoading)
{
    <div class="card border-0 shadow-sm"><div class="card-body">Cargando…</div></div>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="card border-0 shadow-sm"><div class="card-body text-danger">@error</div></div>
}
else
{
    <EditForm Model="@vm" OnValidSubmit="@Guardar">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Identificación -->
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-transparent"><strong>Identificación</strong></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-12">
                        <label class="form-label">ID Lote</label>
                        <input class="form-control" value="@vm.Id" disabled />
                    </div>

                    <div class="col-md-9 col-12">
                        <label class="form-label">Producto</label>
                        <InputSelect class="form-select"
                                     value="@vm.IdPro"
                                     @onchange="OnProductoChanged">
                            <option value="0">— Selecciona un producto —</option>
                            @foreach (var p in productos)
                            {
                                <option value="@p.Id">@p.Nombre</option>
                            }
                        </InputSelect>
                        <small class="text-muted d-block mt-1">
                            Selecciona el producto; el valor guardado será su ID.
                        </small>
                        <ValidationMessage For="@(() => vm.IdPro)" />
                    </div>

                    <div class="col-md-6 col-12">
                        <label class="form-label">Nombre (referencia)</label>
                        <input class="form-control" value="@vm.NombreProducto" disabled />
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="form-label">Tipo (referencia)</label>
                        <input class="form-control" value="@vm.TipoProducto" disabled />
                    </div>
                </div>
            </div>
        </div>

        <!-- Fechas -->
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-transparent"><strong>Fechas</strong></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4 col-12">
                        <label class="form-label">Fecha de compra</label>
                        <InputDate class="form-control" @bind-Value="vm.FecCom" />
                        <ValidationMessage For="@(() => vm.FecCom)" />
                    </div>
                    <div class="col-md-4 col-12">
                        <label class="form-label">Fecha de expiración</label>
                        <InputDate class="form-control" @bind-Value="vm.FecExp" />
                        <ValidationMessage For="@(() => vm.FecExp)" />
                    </div>
                    <div class="col-md-4 col-12">
                        <label class="form-label">Estado actual</label>
                        <input class="form-control" value="@(vm.EstLot ? "Activo" : "Inactivo")" disabled />
                    </div>
                </div>
            </div>
        </div>

        <!-- Cantidades y precios -->
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-transparent"><strong>Cantidades y precios</strong></div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-12">
                        <label class="form-label">Cantidad del lote</label>
                        <InputNumber class="form-control" @bind-Value="vm.CanLot" />
                        <ValidationMessage For="@(() => vm.CanLot)" />
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">Disponible</label>
                        <InputNumber class="form-control" @bind-Value="vm.CanDis" />
                        <ValidationMessage For="@(() => vm.CanDis)" />
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">Precio compra ($)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <InputNumber class="form-control" @bind-Value="vm.PreCom" />
                        </div>
                        <ValidationMessage For="@(() => vm.PreCom)" />
                    </div>
                    <div class="col-md-3 col-12">
                        <label class="form-label">Precio venta ($)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <InputNumber class="form-control" @bind-Value="vm.PreVen" />
                        </div>
                        <ValidationMessage For="@(() => vm.PreVen)" />
                        @if (precioMinSugerido.HasValue && precioMaxSugerido.HasValue)
                        {
                            <small class="text-muted">
                                Rango sugerido: $@precioMinSugerido.Value:0.00 – $@precioMaxSugerido.Value:0.00
                            </small>
                        }
                    </div>
                </div>
            </div>

            <div class="card-footer d-flex justify-content-end gap-2 bg-transparent">
                <button type="button" class="btn btn-light" @onclick="Volver">Cancelar</button>
                <button type="submit" class="btn btn-primary">
                    <i class="ri-save-3-line me-1"></i> Guardar cambios
                </button>
            </div>
        </div>
    </EditForm>
}

@code {
    [Parameter] public int id { get; set; }

    private bool isLoading = true;
    private string? error;
    private LoteVM vm = new();
    private List<ProductoDto> productos = new();

    // Política de precios
    private const decimal MargenBase = 0.30m;
    private const decimal FactorDemanda = 0.10m;

    private decimal? precioMinSugerido;
    private decimal? precioMaxSugerido;

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            isLoading = true;
            error = null;

            var dto = await LotesApi.GetByIdAsync(id);
            if (dto is null)
            {
                error = $"No se encontró el lote {id}.";
                return;
            }

            vm = new LoteVM
            {
                Id = dto.Id,
                IdPro = dto.IdPro,
                NombreProducto = dto.NombreProducto ?? "",
                TipoProducto = dto.TipoProducto ?? "",
                FecCom = dto.FecCom,
                FecExp = dto.FecExp,
                CanLot = dto.CanLot,
                CanDis = dto.CanDis,
                PreCom = dto.PreCom,
                PreVen = dto.PreVen,
                EstLot = dto.EstLot
            };

            productos = await ProductosApi.GetAllAsync();

            var pSel = productos.FirstOrDefault(p => p.Id == vm.IdPro);
            if (pSel is not null)
            {
                vm.NombreProducto = pSel.Nombre;
                vm.TipoProducto = pSel.NombreCategoria;
            }


            await ObtenerRangoPrecioAsync();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnProductoChanged(ChangeEventArgs e)
    {
        if (!int.TryParse(e?.Value?.ToString(), out var nuevoId)) nuevoId = 0;

        vm.IdPro = nuevoId;

        if (nuevoId <= 0)
        {
            vm.NombreProducto = "";
            vm.TipoProducto = "";
            precioMinSugerido = precioMaxSugerido = null;
            return;
        }

        var p = productos.FirstOrDefault(x => x.Id == nuevoId) ?? await ProductosApi.GetByIdAsync(nuevoId);
        vm.NombreProducto = p?.Nombre ?? "";
        vm.TipoProducto = p?.NombreCategoria ?? "";


        await ObtenerRangoPrecioAsync();
    }

    private async Task<bool> ValidarCamposAsync()
    {
        if (vm.IdPro <= 0)
        {
            await Alert("Producto requerido", "Selecciona un producto válido.");
            return false;
        }

        if (vm.FecCom > vm.FecExp)
        {
            await Alert("Fechas inconsistentes", "La fecha de compra no puede ser mayor que la de expiración.");
            return false;
        }

        if (vm.CanDis > vm.CanLot)
        {
            await Alert("Cantidad inválida", "Disponible no puede superar la cantidad del lote.");
            return false;
        }

        if (vm.PreCom <= 0)
        {
            await Alert("Precio de compra inválido", "El precio de compra debe ser mayor que 0.");
            return false;
        }

        var rango = await ObtenerRangoPrecioAsync();
        if (rango is null)
        {
            return true;
        }

        var (min, max) = rango.Value;

        if (vm.PreVen < min || vm.PreVen > max)
        {
            await Alert(
                "Precio de venta fuera de rango",
                $"El precio de venta debe estar entre <strong>${min:0.00}</strong> y <strong>${max:0.00}</strong> " +
                "para mantener la rentabilidad del producto."
            );
            return false;
        }

        return true;
    }

    private async Task<(decimal Min, decimal Max)?> ObtenerRangoPrecioAsync()
    {
        if (vm.IdPro <= 0 || vm.PreCom <= 0)
        {
            precioMinSugerido = precioMaxSugerido = null;
            return null;
        }

        List<LoteDto> lotesProducto;
        try
        {
            lotesProducto = await LotesApi.GetByProductIdAsync(vm.IdPro);
        }
        catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.NotFound)
        {
            lotesProducto = new List<LoteDto>();
        }

        var otrosLotes = lotesProducto
            .Where(l => l.Id != vm.Id)
            .ToList();

        decimal costoFifo;
        decimal ultimoCosto;
        decimal costoBase;

        if (otrosLotes.Any())
        {
            var activos = otrosLotes
                .Where(l => l.CanDis > 0)
                .OrderBy(l => l.FecCom)
                .ToList();

            if (activos.Any())
            {
                costoFifo = activos.First().PreCom;
                ultimoCosto = activos.Last().PreCom;
            }
            else
            {
                var ordenados = otrosLotes.OrderBy(l => l.FecCom).ToList();
                costoFifo = ordenados.First().PreCom;
                ultimoCosto = ordenados.Last().PreCom;
            }

            costoBase = ultimoCosto;
        }
        else
        {
            // Caso en el que este lote es el único del producto
            costoFifo = vm.PreCom;
            ultimoCosto = vm.PreCom;
            costoBase = vm.PreCom;
        }

        var (min, max) = CalcularRangoPrecio(costoFifo, ultimoCosto, costoBase);
        precioMinSugerido = min;
        precioMaxSugerido = max;
        return (min, max);
    }

    private (decimal Min, decimal Max) CalcularRangoPrecio(decimal costoFifo, decimal ultimoCosto, decimal costoBase)
    {
        var minimo = Math.Max(
            costoFifo * 1.20m,
            ultimoCosto * 1.15m);

        var maximo = costoBase * (1 + MargenBase) * (1 + FactorDemanda);

        return (
            decimal.Round(minimo, 2, MidpointRounding.AwayFromZero),
            decimal.Round(maximo, 2, MidpointRounding.AwayFromZero)
        );
    }

    private async Task Guardar()
    {
        if (!await ValidarCamposAsync())
            return;

        try
        {
            var req = new LoteUpdateRequest
            {
                IdPro = vm.IdPro,
                FecCom = vm.FecCom,
                FecExp = vm.FecExp,
                CanLot = vm.CanLot,
                CanDis = vm.CanDis,
                PreCom = vm.PreCom,
                PreVen = vm.PreVen
            };

            await LotesApi.UpdateAsync(vm.Id, req);

            await Swal.FireAsync(new()
            {
                Icon = SweetAlertIcon.Success,
                Title = "Lote actualizado",
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Timer = 1600,
                ShowConfirmButton = false
            });

            Nav.NavigateTo("/dashboards/lotes/listar");
        }
        catch (Exception ex)
        {
            await Swal.FireAsync(new()
            {
                Icon = SweetAlertIcon.Error,
                Title = "Error al actualizar",
                Html = $"<small>{ex.Message}</small>"
            });
        }
    }

    private Task Alert(string title, string html) =>
        Swal.FireAsync(new()
        {
            Icon = SweetAlertIcon.Warning,
            Title = title,
            Html = $"<small>{html}</small>",
            ConfirmButtonColor = "#0ea5e9"
        });

    private void Volver() => Nav.NavigateTo("/dashboards/lotes/listar");

    private sealed class LoteVM
    {
        public int Id { get; set; }

        [Range(1, int.MaxValue, ErrorMessage = "Selecciona un producto")]
        public int IdPro { get; set; }

        public string NombreProducto { get; set; } = "";
        public string TipoProducto { get; set; } = "";

        [Required] public DateTime FecCom { get; set; }
        [Required] public DateTime FecExp { get; set; }

        [Range(1, int.MaxValue, ErrorMessage = "Debe ser ≥ 1")]
        public int CanLot { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "Debe ser ≥ 0")]
        public int CanDis { get; set; }

        [Range(0, 999999, ErrorMessage = "Debe ser ≥ 0")]
        public decimal PreCom { get; set; }

        [Range(0, 999999, ErrorMessage = "Debe ser ≥ 0")]
        public decimal PreVen { get; set; }

        public bool EstLot { get; set; }
    }
}
