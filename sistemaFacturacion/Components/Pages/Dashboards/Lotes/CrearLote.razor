@page "/dashboards/lotes/crear"
@page "/dashboards/lotes/crear/{productId:int}"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using System.Net
@using sistemaFacturacion.Models
@using sistemaFacturacion.Services
@inject NavigationManager Nav
@inject ILotesApiClient LotesApi
@inject CurrieTechnologies.Razor.SweetAlert2.SweetAlertService Swal
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<h2 class="titulo-form">Crear lote desde producto</h2>
<p class="descripcion-form">Completa los campos del lote. El lote se creará con estado <strong>Activo</strong>.</p>

<EditForm Model="@lote" OnValidSubmit="@Guardar">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-3">

                <!-- Producto -->
                <div class="col-md-4 col-12">
                    <label class="form-label">ID Producto</label>
                    <input class="form-control" value="@lote.IdPro" disabled />
                </div>
                <div class="col-md-8 col-12">
                    <label class="form-label">Producto</label>
                    <input class="form-control" value="@ProductoNombreMostrada" disabled />
                </div>

                <!-- Fechas -->
                <div class="col-md-4 col-12">
                    <label class="form-label">Fecha de compra</label>
                    <InputDate class="form-control" @bind-Value="lote.FecCom" />
                    <ValidationMessage For="@(() => lote.FecCom)" />
                </div>
                <div class="col-md-4 col-12">
                    <label class="form-label">Fecha de expiración</label>
                    <InputDate class="form-control" @bind-Value="lote.FecExp" />
                    <ValidationMessage For="@(() => lote.FecExp)" />
                </div>

                <!-- Cantidades -->
                <div class="col-md-2 col-12">
                    <label class="form-label">Cant. lote</label>
                    <InputNumber class="form-control" @bind-Value="lote.CanLot" />
                    <ValidationMessage For="@(() => lote.CanLot)" />
                </div>
                <div class="col-md-2 col-12">
                    <label class="form-label">Disponible</label>
                    <InputNumber class="form-control" @bind-Value="lote.CanDis" />
                    <ValidationMessage For="@(() => lote.CanDis)" />
                </div>

                <!-- Precios -->
                <div class="col-md-3 col-12">
                    <label class="form-label">Precio compra ($)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <InputNumber class="form-control" @bind-Value="lote.PreCom" />
                    </div>
                    <ValidationMessage For="@(() => lote.PreCom)" />
                </div>
                <div class="col-md-3 col-12">
                    <label class="form-label">Precio venta ($)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <InputNumber class="form-control" @bind-Value="lote.PreVen" />
                    </div>
                    <ValidationMessage For="@(() => lote.PreVen)" />
                    @if (precioMinSugerido.HasValue && precioMaxSugerido.HasValue)
                    {
                        <small class="text-muted">
                            @($"Rango sugerido: ${precioMinSugerido.Value:0.00} – ${precioMaxSugerido.Value:0.00}")
                        </small>
                    }
                </div>

            </div>
        </div>

        <div class="card-footer d-flex justify-content-end gap-2 bg-transparent">
            <button type="button" class="btn btn-light" @onclick="Cancelar">Cancelar</button>
            <button type="submit" class="btn btn-primary">
                <i class="ri-save-3-line me-1"></i> Guardar
            </button>
        </div>
    </div>
</EditForm>

@code {
    [Parameter] public int? productId { get; set; }
    [SupplyParameterFromQuery(Name = "productName")] public string? productName { get; set; }

    private LoteCreateRequest lote = new();

    // Política de precios
    private const decimal MargenBase = 0.30m;
    private const decimal FactorDemanda = 0.10m;

    private decimal? precioMinSugerido;
    private decimal? precioMaxSugerido;

    private string ProductoNombreMostrada =>
        string.IsNullOrWhiteSpace(productName) ? "(sin nombre)" : productName!;

    protected override void OnParametersSet()
    {
        if (productId.HasValue)
            lote.IdPro = productId.Value;

        if (lote.FecCom == default)
            lote.FecCom = DateTime.Today;

        if (lote.FecExp == default)
            lote.FecExp = DateTime.Today.AddYears(1);
    }

    private async Task<bool> ValidarCamposVisual()
    {
        if (lote.IdPro <= 0)
        {
            await Swal.FireAsync(new()
            {
                Icon = SweetAlertIcon.Warning,
                Title = "Producto no válido",
                Html = "<small>No se ha recibido un producto válido para crear el lote.</small>",
                ConfirmButtonColor = "#0ea5e9"
            });
            return false;
        }

        if (lote.FecCom > lote.FecExp)
        {
            await Swal.FireAsync(new()
            {
                Icon = SweetAlertIcon.Warning,
                Title = "Fechas incorrectas",
                Html = "<small>La fecha de compra no puede ser mayor que la fecha de expiración.</small>",
                ConfirmButtonColor = "#0ea5e9"
            });
            return false;
        }

        if (lote.CanDis > lote.CanLot)
        {
            await Swal.FireAsync(new()
            {
                Icon = SweetAlertIcon.Warning,
                Title = "Cantidad inválida",
                Html = "<small>La cantidad disponible no puede ser mayor a la cantidad del lote.</small>",
                ConfirmButtonColor = "#0ea5e9"
            });
            return false;
        }

        if (lote.PreCom <= 0)
        {
            await Swal.FireAsync(new()
            {
                Icon = SweetAlertIcon.Warning,
                Title = "Precio de compra inválido",
                Html = "<small>El precio de compra debe ser mayor que 0.</small>",
                ConfirmButtonColor = "#0ea5e9"
            });
            return false;
        }

        var rango = await ObtenerRangoPrecioAsync();
        if (rango is null)
        {
            return true;
        }

        var (min, max) = rango.Value;

        if (lote.PreVen < min || lote.PreVen > max)
        {
            await Swal.FireAsync(new()
            {
                Icon = SweetAlertIcon.Warning,
                Title = "Precio de venta fuera de rango",
                Html = $"<small>El precio de venta debe estar entre " +
                       $"<strong>${min:0.00}</strong> y <strong>${max:0.00}</strong> " +
                       $"para mantener la rentabilidad del producto.</small>",
                ConfirmButtonColor = "#0ea5e9"
            });
            return false;
        }

        return true;
    }

    private async Task<(decimal Min, decimal Max)?> ObtenerRangoPrecioAsync()
    {
        if (lote.IdPro <= 0 || lote.PreCom <= 0)
        {
            precioMinSugerido = precioMaxSugerido = null;
            return null;
        }

        List<LoteDto> lotesExistentes;
        try
        {
            lotesExistentes = await LotesApi.GetByProductIdAsync(lote.IdPro);
        }
        catch (HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.NotFound)
        {
            lotesExistentes = new List<LoteDto>();
        }

        decimal costoFifo;
        decimal ultimoCosto;
        decimal costoBase;

        if (lotesExistentes.Any())
        {
            var activos = lotesExistentes
                .Where(l => l.CanDis > 0)
                .OrderBy(l => l.FecCom)
                .ToList();

            if (activos.Any())
            {
                costoFifo = activos.First().PreCom;
                ultimoCosto = activos.Last().PreCom;
            }
            else
            {
                var ordenados = lotesExistentes.OrderBy(l => l.FecCom).ToList();
                costoFifo = ordenados.First().PreCom;
                ultimoCosto = ordenados.Last().PreCom;
            }

            costoBase = ultimoCosto;
        }
        else
        {
            // Caso especial solicitado: primer lote del producto
            costoFifo = lote.PreCom;
            ultimoCosto = lote.PreCom;
            costoBase = lote.PreCom;
        }

        var (min, max) = CalcularRangoPrecio(costoFifo, ultimoCosto, costoBase);
        precioMinSugerido = min;
        precioMaxSugerido = max;
        return (min, max);
    }

    private (decimal Min, decimal Max) CalcularRangoPrecio(decimal costoFifo, decimal ultimoCosto, decimal costoBase)
    {
        var minimo = Math.Max(
            costoFifo * 1.20m,
            ultimoCosto * 1.15m);

        var maximo = costoBase * (1 + MargenBase) * (1 + FactorDemanda);

        return (
            decimal.Round(minimo, 2, MidpointRounding.AwayFromZero),
            decimal.Round(maximo, 2, MidpointRounding.AwayFromZero)
        );
    }

    private async Task Guardar()
    {
        if (!await ValidarCamposVisual())
            return;

        try
        {
            var creado = await LotesApi.CreateAsync(lote);

            bool isDark = false;
            try { isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode"); } catch { }

            await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Success,
                Title = "Lote creado correctamente",
                Html = $"<small>ID generado: <strong>{(creado?.Id > 0 ? creado.Id.ToString() : "")}</strong></small>",
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Timer = 1700,
                ShowConfirmButton = false,
                Background = isDark ? "var(--form-control-bg)" : null,
                Color = isDark ? "var(--default-text-color)" : null
            });

            Nav.NavigateTo("/dashboards/lotes/listar");
        }
        catch (HttpRequestException ex)
        {
            await Swal.FireAsync(new()
            {
                Icon = SweetAlertIcon.Error,
                Title = "Error al crear lote",
                Html = $"<small>{ex.Message}</small>"
            });
        }
    }

    private void Cancelar() => Nav.NavigateTo("/dashboards/lotes");
}
