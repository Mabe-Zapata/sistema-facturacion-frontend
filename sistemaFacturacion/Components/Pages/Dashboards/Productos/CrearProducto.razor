@page "/dashboards/productos/crear"

@using System.ComponentModel.DataAnnotations
@using CurrieTechnologies.Razor.SweetAlert2
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using sistemaFacturacion.Services
@using sistemaFacturacion.Models

@inject IProductosApiClient ProductosApi
@inject ICategoriasApiClient CategoriasApi
@inject ITipoTributarioApiClient TipoTributarioApi
@inject SweetAlertService Swal
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@attribute [Authorize]

<h2 class="titulo-form">Registrar nuevo producto</h2>
<p class="descripcion-form">Completa los campos requeridos para añadir un nuevo producto al sistema.</p>

<EditForm Model="@producto" OnValidSubmit="@HandleValidSubmitAsync" OnInvalidSubmit="@HandleInvalidAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-grid">

        <!-- CATEGORÍA -->
        <div class="campo">
            <label for="categoria">Categoría</label>
            <InputSelect id="categoria"
                         class="form-control"
                         @bind-Value="producto.IdCategoria">
                <option value="">-- Selecciona una categoría --</option>
                @foreach (var cat in categorias)
                {
                    <option value="@cat.Id">@cat.Nombre</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => producto.IdCategoria)" />
        </div>

        <!-- TIPO TRIBUTARIO -->
        <div class="campo">
            <label for="tipoTrib">Tipo tributario</label>
            <InputSelect id="tipoTrib"
                         class="form-control"
                         @bind-Value="producto.IdTipoTributario">
                <option value="">-- Selecciona un tipo tributario --</option>
                @foreach (var tt in tiposTributarios)
                {
                    <option value="@tt.Id">@tt.Nombre (@tt.CodigoSri)</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => producto.IdTipoTributario)" />
        </div>

        <div class="campo">
            <label for="nombre">Nombre</label>
            <InputText id="nombre" @bind-Value="producto.NomPro" class="form-control" />
            <ValidationMessage For="@(() => producto.NomPro)" />
        </div>

        <div class="campo descripcion" style="grid-column: 1 / -1;">
            <label for="descripcion">Descripción</label>
            <InputTextArea id="descripcion" @bind-Value="producto.DesPro" class="form-control" rows="3" />
            <ValidationMessage For="@(() => producto.DesPro)" />
        </div>
    </div>

    <div class="d-flex form-actions mt-4 gap-2">
        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
            @(isSubmitting ? "Guardando..." : "Guardar")
        </button>

        <button type="button" class="btn btn-outline-secondary" @onclick="Cancelar" disabled="@isSubmitting">
            Limpiar
        </button>

        <a class="btn btn-light" href="/dashboards/productos/listar">
            Volver
        </a>
    </div>
</EditForm>

@code {
    private bool isSubmitting = false;
    private ProductoModel producto = new();

    private List<CategoriaProductoDto> categorias = new();
    private List<TipoTributarioDto> tiposTributarios = new();

    // ======================
    // ViewModel de producto
    // ======================
    public class ProductoModel
    {
        [Required(ErrorMessage = "La categoría es obligatoria.")]
        public int? IdCategoria { get; set; }

        [Required(ErrorMessage = "El tipo tributario es obligatorio.")]
        public int? IdTipoTributario { get; set; }

        [Required(ErrorMessage = "El nombre es obligatorio.")]
        [StringLength(100, ErrorMessage = "Máximo 100 caracteres.")]
        public string? NomPro { get; set; }

        [Required(ErrorMessage = "La descripción es obligatoria.")]
        [StringLength(200, ErrorMessage = "Máximo 200 caracteres.")]
        public string? DesPro { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var listaCat = await CategoriasApi.ListarAsync();
            categorias = listaCat.Where(c => c.Estado).ToList();

            var listaTt = await TipoTributarioApi.ListarAsync();
            tiposTributarios = listaTt.Where(t => t.Estado).ToList();
        }
        catch (Exception ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Error,
                Title = "No se pudieron cargar los catálogos",
                Text = Trunca(ex.Message, 200)
            });
        }
    }

    private void Cancelar() => producto = new();

    // ======================
    // Envío de formulario
    // ======================
    private async Task HandleValidSubmitAsync()
    {
        isSubmitting = true;
        try
        {
            var req = new ProductoCreateRequest
            {
                IdCategoria = producto.IdCategoria!.Value,
                IdTipoTributario = producto.IdTipoTributario!.Value,
                Nombre = producto.NomPro!.Trim(),
                Descripcion = producto.DesPro!.Trim(),
                Estado = true
            };

            var creado = await ProductosApi.CrearAsync(req);

            bool isDark = false;
            try { isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode"); } catch { }

            var titleColor = isDark ? "var(--default-text-color)" : "#0f172a";
            var subColor = isDark ? "var(--text-muted)" : "#64748b";
            var boxBg = isDark ? "var(--form-control-bg)" : "#f8fafc";
            var boxBrd = isDark ? "var(--default-border)" : "#e5e7eb";
            var valColor = isDark ? "var(--default-text-color)" : "#0f172a";

            var html =
$@"<div style='text-align:left;font-size:14px;line-height:1.45'>
    <div style='margin:0 0 .5rem'>
        <div style='font-weight:700;font-size:1rem;color:{titleColor}'>{Escape(creado?.Nombre)}</div>
        <div style='font-size:.85rem;color:{subColor}'>
            Categoría: {Escape(creado?.NombreCategoria)}<br/>
            Tipo tributario: {Escape(creado?.NombreTipoTributario)}
        </div>
    </div>
    <div style='background:{boxBg};border:1px solid {boxBrd};border-radius:.5rem;padding:.6rem .75rem'>
        <div style='font-size:.72rem;color:{subColor};letter-spacing:.04em;margin-bottom:.15rem'>ID PRODUCTO</div>
        <code style='font-size:1rem;color:{valColor};font-weight:600'>{creado?.Id}</code>
    </div>
</div>";

            var result = await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Success,
                Title = "Producto creado",
                Html = html,
                ShowCancelButton = true,
                ConfirmButtonText = "Ver listado",
                CancelButtonText = "Crear otro",
                FocusConfirm = false
            });

            if (result.IsConfirmed)
            {
                Nav.NavigateTo("/dashboards/productos/listar");
            }
            else
            {
                producto = new();
                await Swal.FireAsync(new SweetAlertOptions
                {
                    Toast = true,
                    Position = SweetAlertPosition.TopEnd,
                    Icon = SweetAlertIcon.Success,
                    Title = "Listo, puedes crear otro",
                    ShowConfirmButton = false,
                    Timer = 1800,
                    TimerProgressBar = true,
                    Background = isDark ? "var(--form-control-bg)" : null,
                    Color = isDark ? "var(--default-text-color)" : null
                });
            }
        }
        catch (HttpRequestException ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Error,
                Title = "No se pudo crear el producto",
                Text = Trunca(ex.Message, 300),
                Footer = "<small>Revisa los datos o inténtalo más tarde.</small>"
            });
        }
        catch (Exception ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Error,
                Title = "Error inesperado",
                Text = Trunca(ex.Message, 300)
            });
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async Task HandleInvalidAsync(EditContext ctx)
    {
        var errores = ctx.GetValidationMessages().Take(4).Select(Escape);
        await Swal.FireAsync(new SweetAlertOptions
        {
            Icon = SweetAlertIcon.Warning,
            Title = "Completa los campos",
            Html = string.Join("<br/>", errores)
        });
    }

    private static string Trunca(string? s, int max) =>
        string.IsNullOrWhiteSpace(s) ? "" : (s.Length <= max ? s : s[..max] + "…");

    private static string Escape(string? s) =>
        string.IsNullOrEmpty(s) ? "" : s.Replace("<", "&lt;").Replace(">", "&gt;");
}
