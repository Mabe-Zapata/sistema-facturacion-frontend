@page "/dashboards/productos/listar"

@using sistemaFacturacion.Models
@using sistemaFacturacion.Services
@using Microsoft.AspNetCore.Authorization
@using CurrieTechnologies.Razor.SweetAlert2

@attribute [Authorize]

@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject SweetAlertService Swal
@inject IProductosApiClient ProductosApi
@inject ILotesApiClient LotesApi

<div class="page-header mb-3">
    <h2 class="page-title fs-18">Listado de Productos</h2>
    <p class="text-muted">Consulta, búsqueda, filtros, tabla paginada y acciones rápidas.</p>
</div>

@if (cargando)
{
    <div class="alert alert-info">
        <span class="spinner-border spinner-border-sm me-2"></span>
        Cargando productos...
    </div>
}
else if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">

        <i class="ri-error-warning-line me-2"></i>@error
    </div>
}
else
{
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4 col-12">
                    <label class="form-label">Buscar (nombre, categoría o descripción)</label>
                    <input class="form-control"
                           @bind="filtroTexto"
                           @bind:event="oninput"
                           placeholder="Escribe para filtrar..." />
                </div>

                <div class="col-md-2 col-6">
                    <label class="form-label">Estado</label>
                    <select class="form-select" @bind="filtroEstado">
                        <option value="">Todos</option>
                        <option value="activos">Activos</option>
                        <option value="inactivos">Inactivos</option>
                    </select>
                </div>

                <div class="col-md-2 col-6">
                    <label class="form-label">Ordenar por precio</label>
                    <select class="form-select" @bind="ordenPrecio">
                        <option value="">Sin orden</option>
                        <option value="mayor">Precio mayor</option>
                        <option value="menor">Precio menor</option>
                    </select>
                </div>

                <div class="col-md-2 col-6">
                    <label class="form-label">Por página</label>
                    <select class="form-select" @bind="pageSize">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                    </select>
                </div>

                <div class="col-md-2 d-grid col-12">
                    <button class="btn btn-outline-secondary" @onclick="LimpiarFiltros">
                        <i class="ri-filter-off-line me-1"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between bg-transparent">
            <h6 class="mb-0">Productos (@FilteredCount resultados)</h6>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-light" title="Recargar" @onclick="RecargarDatos">
                    <i class="ri-refresh-line"></i>
                </button>
                <button class="btn btn-sm btn-light" title="Anterior" @onclick="PrevPage" disabled="@(pageIndex == 1)">
                    <i class="ri-arrow-left-s-line"></i>
                </button>
                <span class="small text-muted">Página @pageIndex de @TotalPages</span>
                <button class="btn btn-sm btn-light" title="Siguiente" @onclick="NextPage" disabled="@(pageIndex == TotalPages)">
                    <i class="ri-arrow-right-s-line"></i>
                </button>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table-hover mb-0 table align-middle">
                    <thead class="text-muted">
                        <tr>
                            <th>ID</th>
                            <th @onclick="@(() => OrdenarPor(nameof(ProductoDto.Nombre)))" role="button">
                                Nombre @IconoOrden(nameof(ProductoDto.Nombre))
                            </th>
                            <th>Categoria</th>
                            <th>Descripción</th>
                            <th class="text-end">Precio actual</th>
                            <th>Estado</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Paged.Count == 0)
                        {
                            <tr>
                                <td colspan="7" class="text-muted py-4 text-center">
                                    <i class="ri-inbox-line fs-3 d-block mb-2"></i>
                                    No hay productos disponibles.
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var p in Paged)
                            {
                                <tr @key="p.Id">
                                    <td>@p.Id</td>
                                    <td>@p.Nombre</td>
                                    <td>@p.NombreCategoria</td>
                                    <td><small>@p.Descripcion</small></td>
                                    <td class="text-end">
                                        <small>@FormatMoney(GetPrecioActual(p.Id))</small>
                                    </td>
                                    <td>
                                        @if (p.Estado)
                                        {
                                            <span class="badge bg-success-subtle text-success">Activo</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger-subtle text-danger">Inactivo</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                title="Editar producto"
                                                @onclick="() => Editar(p)">
                                            <i class="ri-edit-line"></i>
                                        </button>

                                        <button class="btn btn-sm btn-outline-info me-1"
                                                title="Ver detalles"
                                                @onclick="() => VerDetalles(p)">
                                            <i class="ri-eye-line"></i>
                                        </button>

                                        <button class="btn btn-sm @(p.Estado ? "btn-outline-danger" : "btn-outline-success")"
                                                title="@(p.Estado ? "Inactivar" : "Activar")"
                                                @onclick="() => CambiarEstado(p)">
                                            <i class="@(p.Estado ? "ri-close-circle-line" : "ri-check-line")"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    private List<ProductoDto> productos = new();
    private List<LoteDto> lotes = new();
    private Dictionary<int, decimal> precioPorProducto = new();

    private bool cargando = true;
    private string? error;

    private string? filtroTexto;
    private string? filtroEstado;

    private string? _ordenPrecio;
    private string? ordenPrecio
    {
        get => _ordenPrecio;
        set
        {
            if (_ordenPrecio != value)
            {
                _ordenPrecio = value;
                pageIndex = 1;
            }
        }
    }

    private int pageIndex = 1;
    private int pageSize = 10;
    private string? sortBy;
    private bool sortAsc = true;

    protected override async Task OnInitializedAsync() => await CargarProductos();

    private async Task CargarProductos()
    {
        try
        {
            cargando = true;
            error = null;

            productos = await ProductosApi.GetAllAsync();
            lotes = await LotesApi.GetAllAsync();
            ConstruirPreciosPorProducto();

            bool isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
            await Swal.FireAsync(new SweetAlertOptions
            {
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Success,
                Title = $"✓ {productos.Count} productos cargados",
                ShowConfirmButton = false,
                Timer = 1800,
                TimerProgressBar = true,
                Background = isDark ? "#1e1e1e" : null,
                Color = isDark ? "#e6e6e6" : null
            });
        }
        catch (HttpRequestException ex)
        {
            error = $"Error al cargar productos: {ex.Message}";
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Error al cargar",
                Html = $"<small>{Escape(ex.Message)}</small>",
                Icon = SweetAlertIcon.Error
            });
        }
        finally
        {
            cargando = false;
        }
    }

    /// <summary>
    /// Construye el precio actual por producto a partir de los lotes:
    /// - Toma el lote más antiguo con stock disponible (FIFO) como precio vigente.
    /// - Si no hay stock, usa el último precio de venta conocido.
    /// </summary>
    private void ConstruirPreciosPorProducto()
    {
        if (lotes == null || lotes.Count == 0)
        {
            precioPorProducto = new Dictionary<int, decimal>();
            return;
        }

        precioPorProducto = lotes
            .Where(l => l.EstLot)
            .GroupBy(l => l.IdPro)
            .ToDictionary(
                g => g.Key,
                g =>
                {
                    var ordenados = g
                        .OrderBy(l => l.FecCom)
                        .ToList();

                    // Lote activo FIFO: más antiguo con stock disponible
                    var activo = ordenados
                        .Where(l => l.CanDis > 0)
                        .OrderBy(l => l.FecCom)
                        .FirstOrDefault();

                    if (activo != null && activo.PreVen > 0)
                        return activo.PreVen;

                    // Si no hay stock, uso el último precio de venta conocido
                    var ultimo = ordenados
                        .OrderByDescending(l => l.FecCom)
                        .FirstOrDefault();

                    return ultimo?.PreVen ?? 0m;
                });
    }

    private async Task RecargarDatos()
    {
        bool isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
        await Swal.FireAsync(new SweetAlertOptions
        {
            Toast = true,
            Position = SweetAlertPosition.TopEnd,
            Icon = SweetAlertIcon.Info,
            Title = "Recargando datos...",
            ShowConfirmButton = false,
            Timer = 1000,
            Background = isDark ? "var(--form-control-bg)" : "#fff",
            Color = isDark ? "var(--default-text-color)" : "#1e293b"
        });

        await CargarProductos();
        pageIndex = 1;
    }

    private async Task VerDetalles(ProductoDto p)
    {
        bool isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");

        var colorTitle = isDark ? "var(--default-text-color)" : "#1e293b";
        var colorMuted = isDark ? "var(--text-muted)" : "#64748b";
        var boxBg = isDark ? "var(--form-control-bg)" : "#f8fafc";
        var boxBrd = isDark ? "var(--default-border)" : "#e5e7eb";

        string estadoHtml = p.Estado
            ? "<span style='color:#22c55e;font-weight:600'>Activo</span>"
            : "<span style='color:#ef4444;font-weight:600'>Inactivo</span>";

        var precioActual = GetPrecioActual(p.Id);
        var precioHtml = precioActual > 0
            ? $"<strong>{precioActual:C2}</strong>"
            : "<span class='text-muted'>Sin precio calculado</span>";

        string html = $@"
        <div style='text-align:left;font-size:14px;line-height:1.45'>
            <div style='margin-bottom:.6rem'>
    <div style='font-weight:700;font-size:1.05rem;color:{colorTitle}'>{Escape(p.Nombre)}</div>
    <div style='font-size:.85rem;color:{colorMuted}'>
        Categoría: {Escape(p.NombreCategoria)}
    </div>
</div>
            <div style='background:{boxBg};border:1px solid {boxBrd};border-radius:.5rem;padding:.75rem'>
                <div style='font-size:.82rem;color:{colorMuted};margin-bottom:.25rem'>Descripción</div>
                <div style='font-size:.9rem;color:{colorTitle}'>{Escape(p.Descripcion)}</div>
            </div>
            <div style='margin-top:.75rem;font-size:.85rem;color:{colorMuted}'>
                <p><strong>Estado:</strong> {estadoHtml}</p>
                <p><strong>Precio actual (FIFO):</strong> {precioHtml}</p>
            </div>
        </div>";

        await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "Detalles del producto",
            Html = html,
            Icon = SweetAlertIcon.Info,
            ShowConfirmButton = false,
            ShowCloseButton = true,
            Width = "28rem",
            Background = isDark ? "var(--form-control-bg)" : "#fff",
            Color = isDark ? "var(--default-text-color)" : "#1e293b"
        });
    }

    // === FILTROS Y PAGINACIÓN ===

    private static string Escape(string? s) =>
        string.IsNullOrEmpty(s)
            ? string.Empty
            : s.Replace("<", "&lt;").Replace(">", "&gt;");

    private decimal GetPrecioActual(int productoId) =>
        precioPorProducto.TryGetValue(productoId, out var valor) ? valor : 0m;

    private static string FormatMoney(decimal value) =>
        value <= 0 ? "-" : value.ToString("N2");

    private List<ProductoDto> Filtered
    {
        get
        {
            var q = productos.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(filtroTexto))
            {
                var txt = filtroTexto.Trim().ToLower();
                q = q.Where(p =>
                    (p.Nombre ?? string.Empty).ToLower().Contains(txt) ||
                    (p.NombreCategoria ?? string.Empty).ToLower().Contains(txt) ||
                    (p.Descripcion ?? string.Empty).ToLower().Contains(txt));
            }


            if (!string.IsNullOrWhiteSpace(filtroEstado))
            {
                var activo = filtroEstado == "activos";
                q = q.Where(p => p.Estado == activo);
            }

            // Ordenar por precio si se seleccionó
            if (!string.IsNullOrWhiteSpace(ordenPrecio))
            {
                q = ordenPrecio == "mayor"
                    ? q.OrderByDescending(p => GetPrecioActual(p.Id))
                    : q.OrderBy(p => GetPrecioActual(p.Id));
            }
            else
            {
                q = Ordenar(q);
            }

            return q.ToList();
        }
    }

    private int FilteredCount => Filtered.Count;

    private int TotalPages =>
        Math.Max(1, (int)Math.Ceiling(FilteredCount / (double)pageSize));

    private List<ProductoDto> Paged =>
        Filtered
            .Skip((pageIndex - 1) * pageSize)
            .Take(pageSize)
            .ToList();

    private IEnumerable<ProductoDto> Ordenar(IEnumerable<ProductoDto> src)
    {
        if (string.IsNullOrWhiteSpace(sortBy)) return src;

        Func<ProductoDto, object?> key = sortBy switch
        {
            nameof(ProductoDto.Nombre) => p => p.Nombre ?? string.Empty,
            _ => p => p.Id
        };

        return sortAsc ? src.OrderBy(key) : src.OrderByDescending(key);
    }

    private void OrdenarPor(string prop)
    {
        if (sortBy == prop)
        {
            sortAsc = !sortAsc;
        }
        else
        {
            sortBy = prop;
            sortAsc = true;
        }
        pageIndex = 1;
    }

    private string IconoOrden(string prop) =>
        sortBy != prop ? string.Empty : (sortAsc ? "↑" : "↓");

    private void PrevPage()
    {
        if (pageIndex > 1) pageIndex--;
    }

    private void NextPage()
    {
        if (pageIndex < TotalPages) pageIndex++;
    }

    private async Task LimpiarFiltros()
    {
        filtroTexto = null;
        filtroEstado = null;
        ordenPrecio = null;
        sortBy = null;
        sortAsc = true;
        pageIndex = 1;
        bool isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");

        await Swal.FireAsync(new SweetAlertOptions
        {
            Toast = true,
            Position = SweetAlertPosition.TopEnd,
            Icon = SweetAlertIcon.Info,
            Title = "Filtros limpiados",
            ShowConfirmButton = false,
            Timer = 1500,
            Background = isDark ? "var(--form-control-bg)" : "#fff",
            Color = isDark ? "var(--default-text-color)" : "#1e293b"
        });
    }

    private void Editar(ProductoDto p)
    {
        Navigation.NavigateTo($"/dashboards/productos/editar/{p.Id}");
    }

    private async Task ConfirmarEliminar(ProductoDto p)
    {
        var r = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Eliminar producto?",
            Html = $"<strong>{Escape(p.Nombre)}</strong><br/><small>({Escape(p.NombreCategoria)})</small>",

            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = "Sí, eliminar",
            CancelButtonText = "Cancelar",
            ConfirmButtonColor = "#dc3545"
        });

        if (r.IsConfirmed)
        {
            bool isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
            await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Success,
                Title = "Producto eliminado",
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Timer = 1500,
                ShowConfirmButton = false,
                Background = isDark ? "var(--form-control-bg)" : "#fff",
                Color = isDark ? "var(--default-text-color)" : "#1e293b"
            });

            await CargarProductos();
        }
    }

    private async Task CambiarEstado(ProductoDto p)
    {
        var accion = p.Estado ? "inactivar" : "activar";
        var confirm = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = $"¿Deseas {accion} este producto?",
            Html = $"<strong>{Escape(p.Nombre)}</strong><br/><small>({Escape(p.NombreCategoria)})</small>",

            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = $"Sí, {accion}",
            CancelButtonText = "Cancelar",
            ConfirmButtonColor = p.Estado ? "#dc3545" : "#16a34a"
        });
        if (!confirm.IsConfirmed) return;

        var previo = p.Estado;
        p.Estado = !p.Estado;
        StateHasChanged();

        try
        {
            var actualizado = await ProductosApi.UpdateEstadoAsync(p.Id, p.Estado);
            p.Estado = actualizado.Estado;
            bool isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");

            await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Success,
                Title = p.Estado ? "Producto activado" : "Producto inactivado",
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Timer = 1500,
                ShowConfirmButton = false,
                Background = isDark ? "var(--form-control-bg)" : "#fff",
                Color = isDark ? "var(--default-text-color)" : "#1e293b"
            });
        }
        catch (HttpRequestException ex)
        {
            p.Estado = previo;
            StateHasChanged();

            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "No se pudo cambiar el estado",
                Html = $"<small>{Escape(ex.Message)}</small>",
                Icon = SweetAlertIcon.Error
            });
        }
    }
}
