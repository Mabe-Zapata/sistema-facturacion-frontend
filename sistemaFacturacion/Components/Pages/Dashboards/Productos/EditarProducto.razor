@page "/dashboards/productos/editar"
@page "/dashboards/productos/editar/{IdFromRoute:int}"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using sistemaFacturacion.Models
@using sistemaFacturacion.Services
@using CurrieTechnologies.Razor.SweetAlert2

@inject IProductosApiClient ProductosApi
@inject ICategoriasApiClient CategoriasApi
@inject ITipoTributarioApiClient TipoTributarioApi
@inject SweetAlertService Swal
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav
@attribute [Authorize]

@inject ICategoriasApiClient CategoriasApi
@inject ITipoTributarioApiClient TipoTributarioApi


<div class="page-header mb-3">
    <h2 class="page-title fs-18">Editar producto</h2>
    <p class="text-muted">Busca por ID o navega desde el listado. Editables: tipo, nombre y descripción.</p>
</div>

<!-- Buscador por ID (similar a Editar Cliente) -->
<div class="card mb-3 border-0 shadow-sm">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-6 col-12">
                <label class="form-label">ID del producto</label>
                <InputNumber class="form-control" @bind-Value="SearchId" placeholder="Ej: 1" />
            </div>
            <div class="col-md-2 d-grid col-12">
                <button class="btn btn-primary" @onclick="BuscarProducto" disabled="@cargando">
                    @(cargando ? "Buscando..." : "Buscar")
                </button>
            </div>
            <div class="col-md-4 col-12 text-end">
                <a class="btn btn-light" href="/dashboards/productos/listar">
                    ← Volver al listado
                </a>
            </div>
        </div>
        @if (!string.IsNullOrWhiteSpace(searchError))
        {
            <div class="alert alert-danger mt-3 mb-0">@searchError</div>
        }
    </div>
</div>

@if (cargando)
{
    <div class="alert alert-info"><span class="spinner-border spinner-border-sm me-2"></span>Cargando producto...</div>
}
else if (form is not null)
{
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <EditForm Model="@form" OnValidSubmit="@GuardarCambios">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="row g-3">
                    <div class="col-md-3 col-12">
                        <label class="form-label">ID</label>
                        <InputNumber class="form-control" @bind-Value="form.Id" readonly disabled />
                        <small class="text-muted">No editable.</small>
                    </div>

                    <div class="col-md-4 col-12">
                        <label class="form-label">Categoría</label>
                        <InputSelect class="form-control" @bind-Value="form.IdCategoria">
                            <option value="">-- Selecciona una categoría --</option>
                            @foreach (var cat in categorias)
                            {
                                <option value="@cat.Id">@cat.Nombre</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => form.IdCategoria)" />
                    </div>

                    <div class="col-md-4 col-12">
                        <label class="form-label">Tipo tributario</label>
                        <InputSelect class="form-control" @bind-Value="form.IdTipoTributario">
                            <option value="">-- Selecciona un tipo tributario --</option>
                            @foreach (var tt in tiposTributarios)
                            {
                                <option value="@tt.Id">@tt.Nombre (@tt.CodigoSri)</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => form.IdTipoTributario)" />
                    </div>

                    <div class="col-md-5 col-12">
                        <label class="form-label">Nombre</label>
                        <InputText class="form-control" @bind-Value="form.Nombre" />
                        <ValidationMessage For="@(() => form.Nombre)" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Descripción</label>
                        <InputTextArea class="form-control" @bind-Value="form.Descripcion" rows="3" />
                        <ValidationMessage For="@(() => form.Descripcion)" />
                    </div>

                    <div class="col-md-4 col-12">
                        <label class="form-label">Estado (solo lectura)</label>
                        <input class="form-control" value="@(form.Estado ? "Activo" : "Inactivo")" readonly />
                    </div>

                    @* Si quieres mostrar Precio y tu GET lo trae en el futuro:
                    <div class="col-md-4 col-12">
                        <label class="form-label">Precio ($) (solo lectura)</label>
                        <input class="form-control" value="@form.Precio.ToString("0.00")" readonly />
                    </div>
                    *@
                </div>

                <div class="d-flex mt-4 gap-2">
                    <button type="submit" class="btn btn-primary" disabled="@guardando">
                        @(guardando ? "Guardando..." : "Guardar cambios")
                    </button>
                    <a class="btn btn-light" href="/dashboards/productos/listar">Volver</a>
                </div>
            </EditForm>
        </div>
    </div>
}
else if (yaBusco)
{
    <div class="alert alert-warning">No se encontró un producto con ese ID.</div>
}

@code {
    // ===== Parámetros / estado ====
    [Parameter] public int? IdFromRoute { get; set; }
    private int? _loadedFromId;

    private int? SearchId { get; set; }
    private ProductoEditVM? form;
    private bool cargando = false;
    private bool guardando = false;
    private bool yaBusco = false;
    private string? searchError;
    private int? productoIdActual;

    // ===== VM de edición (con validaciones) ====
    private sealed class ProductoEditVM
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "La categoría es obligatoria.")]
        public int? IdCategoria { get; set; }

        [Required(ErrorMessage = "El tipo tributario es obligatorio.")]
        public int? IdTipoTributario { get; set; }

        [Required, StringLength(100)]
        public string? Nombre { get; set; }

        [Required, StringLength(200)]
        public string? Descripcion { get; set; }

        public bool Estado { get; set; }
    }
    private List<CategoriaProductoDto> categorias = new();
    private List<TipoTributarioDto> tiposTributarios = new();

    protected override async Task OnInitializedAsync()
    {
        categorias = (await CategoriasApi.ListarAsync()).Where(c => c.Estado).ToList();
        tiposTributarios = (await TipoTributarioApi.ListarAsync()).Where(t => t.Estado).ToList();
    }


    // ===== Ciclo de vida: cargar si viene {id} en la ruta ====
    protected override async Task OnParametersSetAsync()
    {
        if (IdFromRoute is int rid && rid > 0 && _loadedFromId != rid)
        {
            _loadedFromId = rid;
            SearchId = rid;
            await CargarPorId(rid);
        }
    }

    // ===== Buscar por ID (similar a Editar Cliente) ====
    private async Task BuscarProducto()
    {
        searchError = null;
        if (SearchId is null || SearchId <= 0)
        {
            searchError = "Ingresa un ID válido (entero > 0).";
            return;
        }
        await CargarPorId(SearchId.Value);
    }

    // ===== Cargar por ID con SweetAlert y toasts ====
    private async Task CargarPorId(int id)
    {
        cargando = true; yaBusco = true; form = null; productoIdActual = null; StateHasChanged();

        try
        {
            var dto = await ProductosApi.GetByIdAsync(id);
            if (dto is null)
            {
                await Swal.FireAsync(new SweetAlertOptions
                {
                    Title = "No encontrado",
                    Text = $"No existe un producto con ID {id}.",
                    Icon = SweetAlertIcon.Warning
                });
                return;
            }

            MapearForm(dto);

            await Swal.FireAsync(new SweetAlertOptions
            {
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Success,
                Title = "Producto cargado",
                ShowConfirmButton = false,
                Timer = 1200,
                Toast = true
            });
        }
        catch (HttpRequestException ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Error al cargar",
                Html = $"<small>{ex.Message}</small>",
                Icon = SweetAlertIcon.Error
            });
        }
        finally { cargando = false; StateHasChanged(); }
    }

    private void MapearForm(ProductoDto dto)
    {
        form = new ProductoEditVM
        {
            Id = dto.Id,
            IdCategoria = dto.IdCategoria,
            IdTipoTributario = dto.IdTipoTributario,
            Nombre = dto.Nombre,
            Descripcion = dto.Descripcion,
            Estado = dto.Estado
        };

    }

    // ===== Guardado con confirmación SweetAlert2 (PUT) ====
    private async Task GuardarCambios()
    {
        if (productoIdActual is null || form is null) return;

        var confirmar = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Guardar cambios?",
            Text = "Se actualizarán la categoría, el tipo tributario, el nombre y la descripción.",

            Icon = SweetAlertIcon.Question,
            ShowCancelButton = true,
            ConfirmButtonText = "Sí, guardar",
            CancelButtonText = "Cancelar"
        });
        if (!confirmar.IsConfirmed) return;

        guardando = true;
        try
        {
            var payload = new ProductoUpdateRequest
            {
                IdCategoria = form.IdCategoria!.Value,
                IdTipoTributario = form.IdTipoTributario!.Value,
                Nombre = form.Nombre!.Trim(),
                Descripcion = form.Descripcion!.Trim(),
                Estado = form.Estado
            };

            var actualizado = await ProductosApi.UpdateAsync(productoIdActual.Value, payload);

            await Swal.FireAsync(new SweetAlertOptions
            {
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Success,
                Title = "Cambios guardados",
                Text = $"“{actualizado.Nombre}” actualizado correctamente.",
                ShowConfirmButton = false,
                Timer = 1500,
                Toast = true
            });

            // Opcional: volver automáticamente al listado
            // Nav.NavigateTo("/dashboards/productos/listar");
        }
        catch (HttpRequestException ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "No se pudo guardar",
                Html = $"<small>{ex.Message}</small>",
                Icon = SweetAlertIcon.Error
            });
        }
        finally { guardando = false; }
    }
}
