@page "/dashboards/empleados/listar"
@using Microsoft.AspNetCore.Authorization
@using CurrieTechnologies.Razor.SweetAlert2
@using sistemaFacturacion.Services
@using sistemaFacturacion.Models
@attribute [Authorize]

@inject IJSRuntime JSRuntime
@inject IEmpleadosApiClient EmpleadosApi
@inject IUsuariosApiClient UsuariosApi
@inject NavigationManager Navigation
@inject SweetAlertService Swal

<div class="page-header mb-4">
    <h1 class="page-title fw-semibold fs-20">Listado de Empleados</h1>
    <p class="text-muted fs-13">Consulta y gestión de empleados</p>
</div>

@if (cargando)
{
    <div class="alert alert-info">
        <span class="spinner-border spinner-border-sm me-2"></span> Cargando empleados...
    </div>
}
else if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">
        <i class="ri-error-warning-line me-2"></i>@error
    </div>
}
else
{
    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-lg-4 col-12">
                    <label class="form-label">Buscar (nombre, apellido, correo, teléfono, cargo)</label>
                    <input class="form-control" @bind="filtroTexto" @bind:event="oninput" placeholder="Escribe para filtrar..." />
                </div>
                <div class="col-lg-2 col-6">
                    <label class="form-label">Estado</label>
                    <select class="form-select" @bind="filtroEstado">
                        <option value="">Todos</option>
                        <option value="activos">Activos</option>
                        <option value="inactivos">Inactivos</option>
                    </select>
                </div>
                <div class="col-lg-2 col-6">
                    <label class="form-label">Por página</label>
                    <select class="form-select" @bind="pageSize">
                        <option>5</option>
                        <option>10</option>
                        <option>20</option>
                    </select>
                </div>
                <div class="col-lg-4 d-grid d-lg-flex justify-content-lg-end col-12 gap-2">
                    <a class="btn btn-success" href="/dashboards/usuarios/crear">
                        <i class="ri-user-add-line me-1"></i>Nuevo Usuario-Empleado
                    </a>
                    <button class="btn btn-outline-secondary" @onclick="Recargar">
                        <i class="ri-refresh-line me-1"></i>Recargar
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="LimpiarFiltros">
                        <i class="ri-filter-off-line me-1"></i>Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between bg-transparent">
            <h6 class="mb-0">Empleados (@FilteredCount resultados)</h6>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-light" title="Anterior" @onclick="PrevPage" disabled="@(pageIndex == 1)">
                    <i class="ri-arrow-left-s-line"></i>
                </button>
                <span class="small text-muted">Página @pageIndex de @TotalPages</span>
                <button class="btn btn-sm btn-light" title="Siguiente" @onclick="NextPage" disabled="@(pageIndex == TotalPages)">
                    <i class="ri-arrow-right-s-line"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table-hover mb-0 table align-middle">
                    <thead class="table-light">
                        <tr>
                            <th @onclick="@(() => OrdenarPor(nameof(RowVM.NomUsu)))" role="button" class="user-select-none">Nombre @IconoOrden(nameof(RowVM.NomUsu))</th>
                            <th @onclick="@(() => OrdenarPor(nameof(RowVM.ApeUsu)))" role="button" class="user-select-none">Apellido @IconoOrden(nameof(RowVM.ApeUsu))</th>
                            <th>Correo</th>
                            <th>Teléfono</th>
                            <th @onclick="@(() => OrdenarPor(nameof(RowVM.CarEmp)))" role="button" class="user-select-none">Cargo @IconoOrden(nameof(RowVM.CarEmp))</th>
                            <th>Sueldo</th>
                            <th @onclick="@(() => OrdenarPor(nameof(RowVM.FecIngreso)))" role="button" class="user-select-none">Fecha Ingreso @IconoOrden(nameof(RowVM.FecIngreso))</th>
                            <th>Estado</th>
                            <th class="text-end">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Paged.Count == 0)
                        {
                            <tr>
                                <td colspan="9" class="text-muted py-4 text-center">
                                    <i class="ri-inbox-line fs-3 d-block mb-2"></i>No hay resultados con los filtros aplicados.
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var r in Paged)
                            {
                                <tr @key="r.IdUsu">
                                    <td>@r.NomUsu</td>
                                    <td>@r.ApeUsu</td>
                                    <td><small>@r.CorUsu</small></td>
                                    <td><small>@r.TelUsu</small></td>
                                    <td>@r.CarEmp</td>
                                    <td><small>@FormatMoney(r.SueEmp)</small></td>
                                    <td><small class="text-muted">@(r.FecIngreso.HasValue? r.FecIngreso.Value.LocalDateTime.ToString("dd/MM/yyyy") : "-")</small></td>
                                    <td>
                                        @if (r.Est)
                                        {
                                            <span class="badge bg-success-subtle text-success"><i class="ri-check-line"></i> Activo</span>
                                        }
                                        else
                                        {

                                            <span class="badge bg-danger-subtle text-danger"><i class="ri-close-line"></i> Inactivo</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => IrAEditar(r)" title="Editar usuario">
                                            <i class="ri-edit-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info me-1" @onclick="() => VerDetalles(r)" title="Ver detalles">
                                            <i class="ri-eye-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" disabled="@(r.IdEmp is null)" @onclick="() => ConfirmarEliminar(r)" title="Eliminar empleado">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {
    private List<RowVM> items = new();
    private bool cargando = true;
    private string? error;

    private string? filtroTexto;
    private string? filtroEstado;

    private int pageIndex = 1;
    private int _pageSize = 10;
    private int pageSize
    {
        get => _pageSize;
        set { if (_pageSize != value) { _pageSize = value; pageIndex = 1; } }
    }

    private string? sortBy;
    private bool sortAsc = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
        await MostrarToastCreacionSiAplica();
    }

    private async Task CargarDatos()
    {
        try
        {
            cargando = true; error = null;

            var usuarios = await UsuariosApi.GetAllAsync();
            var empleados = await EmpleadosApi.GetAllAsync();
            var empByUsu = empleados.ToDictionary(e => e.IdUsu, e => e);

            items = usuarios
                .Where(u => u.IdRol == 2)
                .Select(u =>
                {
                    empByUsu.TryGetValue(u.IdUsu, out var emp);
                    return new RowVM
                    {
                        IdUsu = u.IdUsu,
                        IdEmp = emp?.IdEmp,
                        NomUsu = u.NomUsu,
                        ApeUsu = u.ApeUsu,
                        CorUsu = u.CorUsu,
                        TelUsu = u.TelUsu,
                        CarEmp = emp?.CarEmp ?? u.CarEmp,
                        SueEmp = emp?.SueEmp ?? u.SueEmp,
                        FecIngreso = emp?.FecEmp ?? u.FecCre,
                        Est = emp?.EstEmp ?? u.EstUsu
                    };
                })
                .OrderBy(r => r.NomUsu)
                .ToList();

            var isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
            await Swal.FireAsync(new SweetAlertOptions
            {
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Success,
                Title = $"✓ {items.Count} empleados cargados",
                ShowConfirmButton = false,
                Timer = 2000,
                TimerProgressBar = true,
                Background = isDark ? "#1e1e1e" : null,
                Color = isDark ? "#e6e6e6" : null
            });
        }
        catch (HttpRequestException ex)
        {
            error = "Error al cargar empleados: " + ex.Message;
            await Swal.FireAsync(new SweetAlertOptions
            {
                Title = "Error al cargar",
                Html = "<small>" + Escape(ex.Message) + "</small>",
                Icon = SweetAlertIcon.Error,
                ConfirmButtonText = "Entendido"
            });
        }
        finally { cargando = false; }
    }

    private async Task Recargar()
    {
        var isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
        await Swal.FireAsync(new SweetAlertOptions
        {
            Toast = true,
            Position = SweetAlertPosition.TopEnd,
            Icon = SweetAlertIcon.Info,
            Title = "Recargando...",
            ShowConfirmButton = false,
            Timer = 1000,
            Background = isDark ? "#1e1e1e" : null,
            Color = isDark ? "#e6e6e6" : null
        });
        await CargarDatos();
    }

    private void LimpiarFiltros()
    {
        filtroTexto = filtroEstado = null;
        sortBy = null; sortAsc = true; pageIndex = 1;
    }

    private List<RowVM> Filtered
    {
        get
        {
            var r = items.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(filtroTexto))
            {
                var q = filtroTexto.Trim().ToLower();
                r = r.Where(x =>
                  (x.NomUsu?.ToLower().Contains(q) ?? false) ||
                  (x.ApeUsu?.ToLower().Contains(q) ?? false) ||
                  (x.CorUsu?.ToLower().Contains(q) ?? false) ||
                  (x.TelUsu?.ToLower().Contains(q) ?? false) ||
                  (x.CarEmp?.ToLower().Contains(q) ?? false));
            }

            if (!string.IsNullOrWhiteSpace(filtroEstado))
            {
                var activo = filtroEstado == "activos";
                r = r.Where(x => x.Est == activo);
            }

            r = Ordenar(r);
            return r.ToList();
        }
    }

    private int FilteredCount => Filtered.Count;
    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredCount / (double)pageSize));
    private List<RowVM> Paged => Filtered.Skip((pageIndex - 1) * pageSize).Take(pageSize).ToList();

    private IEnumerable<RowVM> Ordenar(IEnumerable<RowVM> src)
    {
        if (string.IsNullOrWhiteSpace(sortBy)) return src;

        Func<RowVM, object?> key = sortBy switch
        {
            nameof(RowVM.NomUsu) => x => x.NomUsu ?? "",
            nameof(RowVM.ApeUsu) => x => x.ApeUsu ?? "",
            nameof(RowVM.CarEmp) => x => x.CarEmp ?? "",
            nameof(RowVM.FecIngreso) => x => x.FecIngreso?.UtcDateTime.Ticks ?? 0L,
            _ => x => x.NomUsu ?? ""
        };
        return sortAsc ? src.OrderBy(key) : src.OrderByDescending(key);
    }

    private void OrdenarPor(string prop)
    {
        if (sortBy == prop) sortAsc = !sortAsc;
        else { sortBy = prop; sortAsc = true; }
        pageIndex = 1;
    }

    private string IconoOrden(string prop) => sortBy != prop ? "" : (sortAsc ? "↑" : "↓");
    private void PrevPage() { if (pageIndex > 1) pageIndex--; }
    private void NextPage() { if (pageIndex < TotalPages) pageIndex++; }

    private async Task VerDetalles(RowVM r)
    {
        var html =
          "<div class='text-start'>" +
          "<p><strong>Correo:</strong> " + Escape(r.CorUsu) + "</p>" +
          "<p><strong>Teléfono:</strong> " + Escape(r.TelUsu) + "</p>" +
          "<p><strong>Cargo:</strong> " + Escape(r.CarEmp) + "</p>" +
          "<p><strong>Fecha ingreso:</strong> " + (r.FecIngreso.HasValue ? r.FecIngreso.Value.LocalDateTime.ToString("dd/MM/yyyy") : "-") + "</p>" +
          "<p><strong>Estado:</strong> " + (r.Est ? "Activo" : "Inactivo") + "</p>" +
          "</div>";

        await Swal.FireAsync(new SweetAlertOptions
        {
            Title = Escape(r.NomUsu) + " " + Escape(r.ApeUsu),
            Html = html,
            Icon = SweetAlertIcon.Info,
            ConfirmButtonText = "Cerrar",
            Width = "560px"
        });
    }

    private async Task ConfirmarEliminar(RowVM r)
    {
        if (r.IdEmp is null) return;

        var resp = await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "¿Eliminar empleado?",
            Html = "Se eliminará el empleado <strong>" + Escape(r.NomUsu) + " " + Escape(r.ApeUsu) + "</strong>",
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = true,
            ConfirmButtonText = "Sí, eliminar",
            CancelButtonText = "Cancelar",
            ConfirmButtonColor = "#dc3545",
            CancelButtonColor = "#6c757d"
        });

        if (resp.IsConfirmed)
        {
            try
            {
                var ok = await EmpleadosApi.DeleteAsync(r.IdEmp.Value);
                if (ok)
                {   
                    var isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
                    var idx = items.FindIndex(x => x.IdEmp == r.IdEmp);
                    if (idx >= 0) { items[idx].Est = false; StateHasChanged(); }
                    await Swal.FireAsync(new SweetAlertOptions
                    {
                        Toast = true,
                        Position = SweetAlertPosition.TopEnd,
                        Icon = SweetAlertIcon.Success,
                        Title = "Empleado eliminado",
                        ShowConfirmButton = false,
                        Timer = 1600,
                        TimerProgressBar = true,
                        Background = isDark ? "#1e1e1e" : null,
                        Color = isDark ? "#e6e6e6" : null
                    });
                }
            }
            catch (Exception ex)
            {
                await Swal.FireAsync(new SweetAlertOptions
                {
                    Icon = SweetAlertIcon.Error,
                    Title = "No se pudo eliminar",
                    Text = Trunca(ex.Message, 250)
                });
            }
        }
    }

    private void IrAEditar(RowVM r)
    {
        if (r.IdUsu <= 0) return;
        Navigation.NavigateTo($"/dashboards/empleados/editar/{r.IdUsu}");
    }

    private async Task MostrarToastCreacionSiAplica()
    {
        var created = GetQueryParam("created");
        if (string.Equals(created, "1", StringComparison.OrdinalIgnoreCase))
        {
            var name = GetQueryParam("name") ?? "Empleado";
            var isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
            await Swal.FireAsync(new SweetAlertOptions
            {
                Toast = true,
                Position = SweetAlertPosition.TopEnd,
                Icon = SweetAlertIcon.Success,
                Title = Escape(name) + " creado",
                ShowConfirmButton = false,
                Timer = 2200,
                TimerProgressBar = true,
                Background = isDark ? "#1e1e1e" : null,
                Color = isDark ? "#e6e6e6" : null
            });
            Navigation.NavigateTo("/dashboards/empleados/listar", replace: true);
        }
    }

    private string? GetQueryParam(string name)
    {
        var uri = new Uri(Navigation.Uri);
        var q = uri.Query;
        if (string.IsNullOrEmpty(q) || q.Length <= 1) return null;
        var pairs = q.Substring(1).Split('&', StringSplitOptions.RemoveEmptyEntries);
        foreach (var p in pairs)
        {
            var kv = p.Split('=', 2);
            if (kv.Length == 2 && string.Equals(kv[0], name, StringComparison.OrdinalIgnoreCase))
                return Uri.UnescapeDataString(kv[1].Replace('+', ' '));
        }
        return null;
    }

    private static string FormatMoney(decimal? v) => v.HasValue ? v.Value.ToString("N2") : "-";
    private static string Trunca(string? s, int max) => string.IsNullOrWhiteSpace(s) ? "" : (s!.Length <= max ? s : s[..max] + "…");
    private static string Escape(string? s) => string.IsNullOrEmpty(s) ? "" : s.Replace("<", "&lt;").Replace(">", "&gt;");

    private sealed class RowVM
    {
        public int IdUsu { get; init; }
        public int? IdEmp { get; init; }
        public string NomUsu { get; init; } = "";
        public string ApeUsu { get; init; } = "";
        public string CorUsu { get; init; } = "";
        public string TelUsu { get; init; } = "";
        public string? CarEmp { get; init; }
        public decimal? SueEmp { get; init; }
        public DateTimeOffset? FecIngreso { get; init; }
        public bool Est { get; set; }
    }
}
