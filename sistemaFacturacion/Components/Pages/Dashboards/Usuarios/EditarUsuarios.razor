@page "/dashboards/empleados/editar/{IdUsu:int}"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using CurrieTechnologies.Razor.SweetAlert2
@using sistemaFacturacion.Services
@using sistemaFacturacion.Models
@attribute [Authorize(Roles ="Admin")]

@inject IUsuariosApiClient UsuariosApi
@inject IEmpleadosApiClient EmpleadosApi
@inject SweetAlertService Swal
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav

<div class="page-header mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
            <h1 class="page-title fw-semibold fs-20 mb-1">Editar empleado</h1>
            <div class="text-muted fs-13">
                Actualice el cargo, sueldo y estado del empleado.
            </div>
        </div>
        <div class="btn-list">
            <a href="/dashboards/empleados/listar"
               class="btn btn-secondary-light btn-wave">
                <i class="ri-arrow-go-back-line me-1"></i>
                Volver al listado
            </a>
        </div>
    </div>
</div>

@if (cargando)
{
    <div class="alert alert-info d-flex align-items-center" role="status">
        <span class="spinner-border spinner-border-sm me-2"></span>
        <span>Cargando datos del empleado...</span>
    </div>
}
else if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger d-flex align-items-center">
        <i class="ri-error-warning-line fs-5 me-2"></i>
        <span>@error</span>
    </div>
}
else if (vm is not null)
{
    <div class="row g-3">
        <div class="col-12">
            <div class="card custom-card mb-0 border-0 shadow-sm">
                <div class="card-body d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div class="d-flex align-items-center gap-3">
                        <div class="rounded-circle bg-primary-light d-flex align-items-center justify-content-center p-3">
                            <i class="ri-briefcase-2-line fs-4 text-primary"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">@usuarioNombre @usuarioApellido</h5>
                            <small class="text-muted d-block">@usuarioCorreo</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <span class="badge" style="@EstadoBadgeStyle">@EstadoTexto</span>
                        <span class="badge badge-id-pill">ID Usu: @IdUsu</span>
                        @if (idEmp is not null)
                        {
                            <span class="badge badge-id-pill">ID Emp: @CodEmp</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna: Datos del usuario (solo lectura) -->
        <div class="col-lg-5">
            <div class="card custom-card h-100 border-0 shadow-sm">
                <div class="card-header d-flex align-items-center justify-content-between bg-transparent">
                    <div class="card-title mb-0">
                        Datos del usuario
                    </div>
                    <span class="badge bg-light text-muted">
                        Solo lectura
                    </span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input class="form-control" value="@usuarioNombre" disabled />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Apellido</label>
                        <input class="form-control" value="@usuarioApellido" disabled />
                    </div>
                    <div class="mb-1">
                        <label class="form-label">Correo electrónico</label>
                        <input class="form-control" value="@usuarioCorreo" disabled />
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna: Datos del empleado (editable) -->
        <div class="col-lg-7">
            <div class="card custom-card h-100 border-0 shadow-sm">
                <div class="card-header d-flex align-items-center justify-content-between bg-transparent">
                    <div class="card-title mb-0">
                        Datos del empleado
                    </div>
                    <small class="text-muted">
                        Campos obligatorios marcados con <span class="text-danger">*</span>
                    </small>
                </div>
                <div class="card-body">
                    <EditForm Model="@vm" OnValidSubmit="@GuardarAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert alert-danger small mb-3" />

                        <div class="row g-3">
                            <div class="col-md-7 col-12">
                                <label class="form-label">
                                    Cargo <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="ri-briefcase-2-line"></i>
                                    </span>
                                    <InputText class="form-control"
                                               @bind-Value="vm.CarEmp"
                                               placeholder="Cargo del empleado"
                                               maxlength="120" />
                                </div>
                                <ValidationMessage For="@(() => vm.CarEmp)" />
                            </div>

                            <div class="col-md-5 col-12">
                                <label class="form-label">
                                    Sueldo
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        $
                                    </span>
                                    <InputNumber class="form-control"
                                                 @bind-Value="vm.SueEmp"
                                                 step="0.01"
                                                 min="0"
                                                 inputmode="decimal" />
                                </div>
                                <small class="form-text text-muted">
                                    Valor mensual, se guardará con 2 decimales.
                                </small>
                                <ValidationMessage For="@(() => vm.SueEmp)" />
                            </div>
                        </div>

                        <div class="row g-3 mt-1">
                            <div class="col-md-6 col-12">
                                <label class="form-label">Estado</label>
                                <div class="d-flex align-items-center mt-1 gap-2">
                                    <div class="form-check form-switch m-0">
                                        <InputCheckbox class="form-check-input"
                                                       @bind-Value="vm.EstEmp"
                                                       @onchange="(e) => StateHasChanged()" />
                                    </div>
                                    <span class="badge" style="@EstadoBadgeStyle">@EstadoTexto</span>
                                </div>
                                <small class="form-text text-muted">
                                    Desactive el empleado si ya no debe aparecer en los procesos activos.
                                </small>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <button type="submit"
                                    class="btn btn-primary btn-wave px-4"
                                    disabled="@guardando">
                                @if (guardando)
                                {
                                    <span class="me-2">Guardando</span>
                                    <span class="spinner-border spinner-border-sm align-middle" role="status" aria-hidden="true"></span>
                                }
                                else
                                {
                                    <i class="ri-save-line me-1"></i>
                                    <span>Guardar cambios</span>
                                }
                            </button>

                            <a href="/dashboards/empleados/listar"
                               class="btn btn-secondary-light btn-wave px-4">
                                <i class="ri-close-line me-1"></i>
                                Cancelar
                            </a>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int IdUsu { get; set; }

    private bool cargando = true;
    private bool guardando = false;
    private string? error;

    private int? idEmp;
    private string CodEmp = "";
    private string usuarioNombre = "";
    private string usuarioApellido = "";
    private string usuarioCorreo = "";

    private EmpleadoEditVM? vm;

    private string EstadoTexto => vm?.EstEmp == true ? "Activo" : "Inactivo";
    private string EstadoBadgeStyle => vm?.EstEmp == true
        ? "background:#16a34a;color:#fff;border-radius:9999px;padding:.25rem .6rem;font-weight:700;letter-spacing:.02em"
        : "background:#ef4444;color:#fff;border-radius:9999px;padding:.25rem .6rem;font-weight:700;letter-spacing:.02em";

    protected override async Task OnParametersSetAsync() => await CargarAsync();

    private async Task CargarAsync()
    {
        try
        {
            cargando = true; error = null; vm = null; idEmp = null;

            var u = await UsuariosApi.GetByIdAsync(IdUsu);
            if (u is null) { error = "No se encontró el usuario."; return; }

            usuarioNombre = u.NomUsu;
            usuarioApellido = u.ApeUsu;
            usuarioCorreo = u.CorUsu;

            var emp = (await EmpleadosApi.GetAllAsync()).FirstOrDefault(e => e.IdUsu == IdUsu);
            if (emp is null) { error = "No existe registro de empleado asociado a este usuario."; return; }

            idEmp = emp.IdEmp;
            CodEmp = emp.CodEmp;

            vm = new EmpleadoEditVM
            {
                CarEmp = emp.CarEmp,
                SueEmp = emp.SueEmp,
                EstEmp = emp.EstEmp
            };
        }
        catch (HttpRequestException ex) { error = "Error al cargar: " + ex.Message; }
        finally { cargando = false; }
    }

    private async Task GuardarAsync()
    {
        if (vm is null || idEmp is null) return;

        guardando = true;

        try
        {
            vm.SueEmp = Math.Round(vm.SueEmp, 2, MidpointRounding.AwayFromZero);

            var payload = new UpdateEmpleadoRequest
            {
                IdUsu = IdUsu,
                CarEmp = vm.CarEmp.Trim(),
                SueEmp = vm.SueEmp,
                EstEmp = vm.EstEmp
            };

            await EmpleadosApi.UpdateAsync(idEmp.Value, payload);

            await SincronizarDesdeServidor();

            var isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
            var r = await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Success,
                Title = "Cambios guardados",
                Toast = false,
                ShowCancelButton = true,
                ConfirmButtonText = "Volver al listado",
                CancelButtonText = "Seguir aquí",
                Background = isDark ? "var(--form-control-bg)" : null,
                Color = isDark ? "var(--default-text-color)" : null
            });

            if (r.IsConfirmed) Nav.NavigateTo("/dashboards/empleados/listar");
        }
        catch (HttpRequestException ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Error,
                Title = "No se pudo guardar",
                Text = Trunca(ex.Message, 300)
            });
        }
        finally
        {
            guardando = false;
        }
    }

    private async Task SincronizarDesdeServidor()
    {
        EmpleadoDto? emp = null;
        try
        {
            emp = (await EmpleadosApi.GetAllAsync()).FirstOrDefault(e => e.IdUsu == IdUsu);
        }
        catch { }
        if (emp is null) return;

        idEmp = emp.IdEmp;
        CodEmp = emp.CodEmp;
        vm!.CarEmp = emp.CarEmp;
        vm!.SueEmp = emp.SueEmp;
        vm!.EstEmp = emp.EstEmp;
        StateHasChanged();
    }

    private static string Trunca(string? s, int max) =>
        string.IsNullOrWhiteSpace(s) ? "" : (s!.Length <= max ? s : s[..max] + "…");

    public sealed class EmpleadoEditVM
    {
        [Required, StringLength(120)]
        public string CarEmp { get; set; } = "";
        [Range(0, 1000000000)]
        public decimal SueEmp { get; set; }
        public bool EstEmp { get; set; }
    }
}
