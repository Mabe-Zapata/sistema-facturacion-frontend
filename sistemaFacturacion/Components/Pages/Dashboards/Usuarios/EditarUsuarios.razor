@page "/dashboards/empleados/editar/{IdUsu:int}"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using CurrieTechnologies.Razor.SweetAlert2
@using sistemaFacturacion.Services
@using sistemaFacturacion.Models
@attribute [Authorize]

@inject IUsuariosApiClient UsuariosApi
@inject IEmpleadosApiClient EmpleadosApi
@inject SweetAlertService Swal
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav

<div class="page-header mb-4">
    <h1 class="page-title fw-semibold fs-20">Editar Empleado</h1>
    <p class="text-muted fs-13">Actualiza los datos del empleado</p>
</div>

@if (cargando)
{
    <div class="alert alert-info">
        <span class="spinner-border spinner-border-sm me-2"></span> Cargando datos...
    </div>
}
else if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">
        <i class="ri-error-warning-line me-2"></i>@error
    </div>
}
else if (vm is not null)
{
    <div class="row g-3">
        <div class="col-12">
            <div class="card mb-0 border-0 shadow-sm">
                <div class="card-body d-flex align-items-center justify-content-between flex-wrap">
                    <div class="d-flex align-items-center gap-3">
                        <div class="rounded-circle bg-primary-subtle p-3"><i class="ri-briefcase-2-line fs-4"></i></div>
                        <div>
                            <h5 class="mb-0">@usuarioNombre @usuarioApellido</h5>
                            <small class="text-muted">@usuarioCorreo</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge" style="@EstadoBadgeStyle">@EstadoTexto</span>
                        <span class="badge text-bg-light">ID Usu: @IdUsu</span>
                        @if (idEmp is not null)
                        {
                            <span class="badge text-bg-light">ID Emp: @idEmp</span>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0">Datos del usuario</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input class="form-control" value="@usuarioNombre" disabled />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Apellido</label>
                        <input class="form-control" value="@usuarioApellido" disabled />
                    </div>
                    <div class="mb-1">
                        <label class="form-label">Correo electrónico</label>
                        <input class="form-control" value="@usuarioCorreo" disabled />
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h6 class="mb-0">Datos del empleado</h6>
                </div>
                <div class="card-body">
                    <EditForm Model="@vm" OnValidSubmit="@GuardarAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="row g-3">
                            <div class="col-md-7 col-12">
                                <label class="form-label">Cargo</label>
                                <InputText class="form-control" @bind-Value="vm.CarEmp" placeholder="Cargo del empleado" maxlength="120" />
                                <ValidationMessage For="@(() => vm.CarEmp)" />
                            </div>
                            <div class="col-md-5 col-12">
                                <label class="form-label">Sueldo</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <InputNumber class="form-control" @bind-Value="vm.SueEmp" step="0.01" min="0" inputmode="decimal" />
                                </div>
                                <ValidationMessage For="@(() => vm.SueEmp)" />
                            </div>
                        </div>

                        <div class="row g-3 mt-1">
                            <div class="col-md-6 col-12">
                                <label class="form-label">Estado</label>
                                <div class="d-flex align-items-center mt-1 gap-2">
                                    <div class="form-check form-switch m-0">
                                        <InputCheckbox class="form-check-input" @bind-Value="vm.EstEmp" @onchange="(e) => StateHasChanged()" />
                                    </div>
                                    <span class="badge" style="@EstadoBadgeStyle">@EstadoTexto</span>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <button type="submit" class="btn btn-warning px-4" disabled="@guardando">
                                @if (guardando)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Guardar cambios
                            </button>
                            <a href="/dashboards/empleados/listar" class="btn btn-secondary px-4">Cancelar</a>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int IdUsu { get; set; }

    private bool cargando = true;
    private bool guardando = false;
    private string? error;

    private int? idEmp;
    private string usuarioNombre = "";
    private string usuarioApellido = "";
    private string usuarioCorreo = "";

    private EmpleadoEditVM? vm;

    private string EstadoTexto => vm?.EstEmp == true ? "Activo" : "Inactivo";
    private string EstadoBadgeStyle => vm?.EstEmp == true
        ? "background:#16a34a;color:#fff;border-radius:9999px;padding:.25rem .6rem;font-weight:700;letter-spacing:.02em"
        : "background:#ef4444;color:#fff;border-radius:9999px;padding:.25rem .6rem;font-weight:700;letter-spacing:.02em";

    protected override async Task OnParametersSetAsync() => await CargarAsync();

    private async Task CargarAsync()
    {
        try
        {
            cargando = true; error = null; vm = null; idEmp = null;

            var u = await UsuariosApi.GetByIdAsync(IdUsu);
            if (u is null) { error = "No se encontró el usuario."; return; }

            usuarioNombre = u.NomUsu;
            usuarioApellido = u.ApeUsu;
            usuarioCorreo = u.CorUsu;

            var emp = (await EmpleadosApi.GetAllAsync()).FirstOrDefault(e => e.IdUsu == IdUsu);
            if (emp is null) { error = "No existe registro de empleado asociado a este usuario."; return; }

            idEmp = emp.IdEmp;

            vm = new EmpleadoEditVM
            {
                CarEmp = emp.CarEmp,
                SueEmp = emp.SueEmp,
                EstEmp = emp.EstEmp
            };
        }
        catch (HttpRequestException ex) { error = "Error al cargar: " + ex.Message; }
        finally { cargando = false; }
    }

    private async Task GuardarAsync()
    {
        if (vm is null || idEmp is null) return;

        guardando = true;

        try
        {
            vm.SueEmp = Math.Round(vm.SueEmp, 2, MidpointRounding.AwayFromZero);

            var payload = new UpdateEmpleadoRequest
            {
                IdUsu = IdUsu,
                CarEmp = vm.CarEmp.Trim(),
                SueEmp = vm.SueEmp,
                EstEmp = vm.EstEmp
            };

            await EmpleadosApi.UpdateAsync(idEmp.Value, payload);

            await SincronizarDesdeServidor();

            var isDark = await JSRuntime.InvokeAsync<bool>("isAppInDarkMode");
            var r = await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Success,
                Title = "Cambios guardados",
                Toast = false,
                ShowCancelButton = true,
                ConfirmButtonText = "Volver al listado",
                CancelButtonText = "Seguir aquí",
                Background = isDark ? "var(--form-control-bg)" : null,
                Color = isDark ? "var(--default-text-color)" : null
            });

            if (r.IsConfirmed) Nav.NavigateTo("/dashboards/empleados/listar");
        }
        catch (HttpRequestException ex)
        {
            await Swal.FireAsync(new SweetAlertOptions
            {
                Icon = SweetAlertIcon.Error,
                Title = "No se pudo guardar",
                Text = Trunca(ex.Message, 300)
            });
        }
        finally
        {
            guardando = false;
        }
    }

    private async Task SincronizarDesdeServidor()
    {
        EmpleadoDto? emp = null;
        try
        {
            emp = (await EmpleadosApi.GetAllAsync()).FirstOrDefault(e => e.IdUsu == IdUsu);
        }
        catch { }
        if (emp is null) return;

        idEmp = emp.IdEmp;
        vm!.CarEmp = emp.CarEmp;
        vm!.SueEmp = emp.SueEmp;
        vm!.EstEmp = emp.EstEmp;
        StateHasChanged();
    }

    private static string Trunca(string? s, int max) =>
        string.IsNullOrWhiteSpace(s) ? "" : (s!.Length <= max ? s : s[..max] + "…");

    public sealed class EmpleadoEditVM
    {
        [Required, StringLength(120)]
        public string CarEmp { get; set; } = "";
        [Range(0, 1000000000)]
        public decimal SueEmp { get; set; }
        public bool EstEmp { get; set; }
    }
}
