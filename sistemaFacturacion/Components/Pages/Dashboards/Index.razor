@page "/dashboard/sales"
@using ApexCharts
@using System.Globalization
@using FlatpickrBlazor
@using FlatpickrBlazor.Components
@using Microsoft.AspNetCore.Authorization
@inject NavigationManager Nav
@inject HttpClient Http
@attribute [Authorize]


<!-- Header / Filtros -->
<div class="d-flex align-items-center justify-content-between page-header-breadcrumb mb-3 flex-wrap gap-2">
    <div>
        <h1 class="page-title fw-medium fs-20 mb-0">Dashboard de Facturación</h1>
        <div class="text-muted fs-12">Ventas, facturas SRI y stock (últimos 30 días por defecto)</div>
    </div>

    <div class="d-flex align-items-center flex-wrap gap-2">
        <!-- Rango de fechas -->
        <div class="form-group custom-main-page">
            <Flatpickr class="form-control breadcrumb-input"
                       @ref="_datepicker"
                       Options="@calendarOpts"
                       @onchange="OnDateRangeChanged" />
        </div>

        <!-- Estado SRI -->
        <div class="form-group">
            <select class="form-select" @bind="Filters.SriStatus" @bind:after="OnFiltersChanged">
                <option value="">Todos los estados SRI</option>
                @foreach (var s in SriStates)
                {
                    <option value="@s">@s</option>
                }
            </select>
        </div>

        <!-- Vendedor / Empleado -->
        <div class="form-group">
            <select class="form-select" @bind="Filters.SalesUserId" @bind:after="OnFiltersChanged">
                <option value="">Todos los vendedores</option>
                @foreach (var u in Sellers)
                {
                    <option value="@u.Id">@u.Name</option>
                }
            </select>
        </div>

        <!-- Sucursal -->
        <div class="form-group">
            <select class="form-select" @bind="Filters.BranchId" @bind:after="OnFiltersChanged">
                <option value="">Todas las sucursales</option>
                @foreach (var b in Branches)
                {
                    <option value="@b.Id">@b.Name</option>
                }
            </select>
        </div>

        <!-- Comparar -->
        <div class="form-check form-switch ms-2">
            <input class="form-check-input" type="checkbox" role="switch" id="switchCompare"
                   @bind="Filters.CompareWithPrevious" @bind:after="OnFiltersChanged" />
            <label class="form-check-label" for="switchCompare">Comparar</label>
        </div>

        <!-- Botones -->
        <div class="btn-list ms-2">
            <button class="btn btn-icon btn-primary btn-wave" @onclick="ApplyFilters" title="Aplicar filtros">
                <i class="ri-refresh-line"></i>
            </button>
            <button class="btn btn-icon btn-secondary btn-wave me-0" @onclick="ResetFilters" title="Limpiar filtros">
                <i class="ri-filter-3-line"></i>
            </button>
        </div>
    </div>
</div>

@code {
    // ======== Filtros ========
    public sealed class DashboardFilters
    {
        public DateTime? From { get; set; }
        public DateTime? To { get; set; }
        public string? BranchId { get; set; } = "";
        public string? SalesUserId { get; set; } = "";
        public string? SriStatus { get; set; } = "";
        public bool CompareWithPrevious { get; set; } = false;
    }
    public DashboardFilters Filters { get; set; } = new();

    // Catálogos (mock; enlaza a tu API)
    public List<string> SriStates { get; set; } = new() { "AUTORIZADA", "DEVUELTA", "RECHAZADA", "ENVIADA", "ANULADA" };
    public List<IdName> Sellers { get; set; } = new() { new("U-001", "Mateo Auz"), new("U-002", "Xabier Pérez") };
    public List<IdName> Branches { get; set; } = new() { new("BR-01", "Matriz"), new("BR-02", "Sucursal Norte") };
    public record IdName(string Id, string Name);

    // Flatpickr (últimos 30 días)
    private Flatpickr? _datepicker;
    private FlatpickrOptions calendarOpts = new()
    {
        Inline = false,
        Mode = FlatpickrOptionsMode.Range,
        DateFormat = "Y-m-d",
        DefaultDate = new List<string>
    {
      DateTime.UtcNow.AddDays(-29).ToString("yyyy-MM-dd"),
      DateTime.UtcNow.ToString("yyyy-MM-dd")
    }
    };
    private void OnDateRangeChanged(ChangeEventArgs _) { /* bind manual si deseas */ }
    private void OnFiltersChanged() => PushFiltersToUrl();
    private void PushFiltersToUrl()
    {
        var q = new Dictionary<string, object?>();
        if (Filters.From is not null) q["from"] = Filters.From!.Value.ToString("yyyy-MM-dd");
        if (Filters.To is not null) q["to"] = Filters.To!.Value.ToString("yyyy-MM-dd");
        if (!string.IsNullOrWhiteSpace(Filters.BranchId)) q["branch"] = Filters.BranchId;
        if (!string.IsNullOrWhiteSpace(Filters.SalesUserId)) q["user"] = Filters.SalesUserId;
        if (!string.IsNullOrWhiteSpace(Filters.SriStatus)) q["sri"] = Filters.SriStatus;
        if (Filters.CompareWithPrevious) q["compare"] = "1";
        Nav.NavigateTo(Nav.GetUriWithQueryParameters(q!), forceLoad: false);
    }

    // ======== KPIs ========
    public sealed class KpiCard
    {
        public string Title { get; set; } = "";
        public string Value { get; set; } = "";
        public string Sub { get; set; } = ""; // texto pequeño (ej.: “+4.2% vs. período anterior”)
        public string BadgeClass { get; set; } = "success";
        public string SvgColor { get; set; } = "primary";
        public MarkupString IconSvg { get; set; }
    }
    private List<KpiCard> Kpis = new();

    // ======== Serie Ventas ========
    private enum TimeBucket { Day, Week, Month }
    private TimeBucket _bucket = TimeBucket.Day;

    public sealed class SalesPoint
    {
        public string BucketLabel { get; set; } = "";
        public decimal Ventas { get; set; }    // total monto (con IVA)
        public decimal Subtotal { get; set; }  // sin IVA
        public decimal IVA { get; set; }       // IVA cobrado
        public int FacturasAut { get; set; }   // autorizadas
    }
    private List<SalesPoint> Sales = new();
    private ApexChartOptions<SalesPoint> SalesOptions = new();

    // ======== Top Productos / Alertas ========
    public sealed class TopProduct { public string Nombre { get; set; } = ""; public int Cantidad { get; set; } }
    public sealed class StockAlert { public string Codigo { get; set; } = ""; public string Nombre { get; set; } = ""; public int Stock { get; set; } public int Minimo { get; set; } }
    private List<TopProduct> TopProductos = new();
    private List<StockAlert> AlertasStock = new();

    // ======== Últimas Facturas ========
    public sealed class InvoiceRow
    {
        public string Numero { get; set; } = "";
        public string Cliente { get; set; } = "";
        public DateTime Fecha { get; set; }
        public string EstadoSRI { get; set; } = "";
        public decimal Total { get; set; }
    }
    private List<InvoiceRow> UltimasFacturas = new();

    protected override async Task OnInitializedAsync()
    {
        BuildChartOptions();
        await LoadAllAsync(); // carga inicial
    }

    private async Task LoadAllAsync()
    {
        // TODO: reemplazar por llamadas reales a tu backend con Filters y _bucket
        // Ejemplos:
        // var dto = await Http.GetFromJsonAsync<OverviewDto>($"api/facturas/overview?from=...&to=...&bucket={_bucket}&branch=...");

        // MOCK: KPIs
        Kpis = new()
    {
      new KpiCard { Title="Ventas del período", Value=FormatMoney(4320), Sub="+2.1% vs. ant.", BadgeClass="success",
        SvgColor="success", IconSvg=(MarkupString)"<svg width='20' height='20' viewBox='0 0 24 24' fill='none' .../>"},
      new KpiCard { Title="Facturas autorizadas", Value="128", Sub="+4.2% vs. ant.", BadgeClass="success",
        SvgColor="primary", IconSvg=(MarkupString)"<svg width='20' height='20' viewBox='0 0 24 24' fill='none' .../>"},
      new KpiCard { Title="Rechazadas/Devueltas", Value="6", Sub="-1.0% vs. ant.", BadgeClass="warning",
        SvgColor="warning", IconSvg=(MarkupString)"<svg width='20' height='20' viewBox='0 0 24 24' fill='none' .../>"},
      new KpiCard { Title="IVA cobrado", Value=FormatMoney(540), Sub="+0.8% vs. ant.", BadgeClass="info",
        SvgColor="secondary", IconSvg=(MarkupString)"<svg width='20' height='20' viewBox='0 0 24 24' fill='none' .../>"},
    };

        // MOCK: Serie ventas
        Sales = GenerateSalesMock(Filters.From, Filters.To, _bucket);

        // MOCK: Top productos y alertas de stock
        TopProductos = new() {
      new() { Nombre="Teclado Mecánico", Cantidad=42 },
      new() { Nombre="Mouse Inalámbrico", Cantidad=37 },
      new() { Nombre="Monitor 24''", Cantidad=21 },
      new() { Nombre="USB 64GB", Cantidad=19 },
      new() { Nombre="Laptop 14''", Cantidad=11 },
    };
        AlertasStock = new() {
      new() { Codigo="P-001", Nombre="USB 64GB", Stock=7, Minimo=10 },
      new() { Codigo="P-014", Nombre="Tóner Q2612A", Stock=3, Minimo=5 },
    };

        // MOCK: Últimas facturas
        UltimasFacturas = new() {
      new() { Numero="001-001-0000123", Cliente="María Zapata", Fecha=DateTime.Today.AddDays(-1), EstadoSRI="AUTORIZADA", Total=128.50m },
      new() { Numero="001-001-0000124", Cliente="Xabier Pérez", Fecha=DateTime.Today.AddDays(-1), EstadoSRI="DEVUELTA",   Total=75.10m  },
      new() { Numero="001-001-0000125", Cliente="Erick Guerrón", Fecha=DateTime.Today,           EstadoSRI="AUTORIZADA", Total=420.00m },
    };

        StateHasChanged();
    }

    private string FormatMoney(decimal v)
    {
        if (v >= 1_000_000) return $"${Math.Round(v / 1_000_000M, 1)}M";
        if (v >= 1_000) return $"${Math.Round(v / 1_000M, 1)}K";
        return $"${v:N2}";
    }

    private void BuildChartOptions()
    {
        SalesOptions = new ApexChartOptions<SalesPoint>
        {
            Chart = new Chart { Toolbar = new Toolbar { Show = false } },
            DataLabels = new DataLabels { Enabled = false },
            Stroke = new Stroke { Curve = Curve.Smooth, Width = new Size(3) },
            Grid = new Grid { StrokeDashArray = 4 },
            Legend = new Legend { Show = true },
            Tooltip = new ApexCharts.Tooltip { Shared = true, Intersect = false },
        };
    }

    private List<SalesPoint> GenerateSalesMock(DateTime? from, DateTime? to, TimeBucket bucket)
    {
        var start = (from ?? DateTime.UtcNow.AddDays(-29)).Date;
        var end = (to ?? DateTime.UtcNow).Date;
        var rng = new Random(99);

        IEnumerable<(DateTime key, string label)> points = bucket switch
        {
            TimeBucket.Day => EachDay(start, end).Select(d => (d, d.ToString("dd MMM"))),
            TimeBucket.Week => EachWeek(start, end).Select(w => (w, $"W{ISOWeek.GetWeekOfYear(w)}")),
            TimeBucket.Month => EachMonth(start, end).Select(m => (m, m.ToString("MMM yyyy"))),
            _ => Array.Empty<(DateTime, string)>()
        };

        var list = new List<SalesPoint>();
        foreach (var p in points)
        {
            var baseF = 1m + (decimal)(Math.Sin(p.key.DayOfYear / 14.0) * 0.12);
            var sub = Math.Max(150m, 700m * baseF + rng.Next(-80, 80));
            var iva = Math.Round(sub * 0.12m, 2);
            var tot = sub + iva;
            var aut = (int)Math.Max(1, 5 * baseF + rng.Next(-1, 2));

            // agrega “peso” por bucket
            if (bucket == TimeBucket.Week) { sub *= 5; iva *= 5; tot *= 5; aut *= 5; }
            if (bucket == TimeBucket.Month) { sub *= 20; iva *= 20; tot *= 20; aut *= 20; }

            list.Add(new SalesPoint { BucketLabel = p.label, Subtotal = Math.Round(sub, 2), IVA = Math.Round(iva, 2), Ventas = Math.Round(tot, 2), FacturasAut = aut });
        }
        return list;
    }

    // helpers de iteración
    private static IEnumerable<DateTime> EachDay(DateTime from, DateTime to) { for (var d = from; d <= to; d = d.AddDays(1)) yield return d; }
    private static IEnumerable<DateTime> EachWeek(DateTime from, DateTime to) { var d = from.AddDays(-(int)(from.DayOfWeek == 0 ? 6 : from.DayOfWeek - DayOfWeek.Monday)); for (; d <= to; d = d.AddDays(7)) yield return d.Date; }
    private static IEnumerable<DateTime> EachMonth(DateTime from, DateTime to) { var d = new DateTime(from.Year, from.Month, 1); for (; d <= to; d = d.AddMonths(1)) yield return d; }

    private async Task ApplyFilters()
    {
        PushFiltersToUrl();
        await LoadAllAsync();
    }
    private async Task ResetFilters()
    {
        Filters = new()
        {
            From = DateTime.UtcNow.AddDays(-29).Date,
            To = DateTime.UtcNow.Date,
            BranchId = "",
            SalesUserId = "",
            SriStatus = "",
            CompareWithPrevious = false
        };
        await LoadAllAsync();
        PushFiltersToUrl();
    }

    private async Task SetBucket(TimeBucket b) { _bucket = b; await LoadAllAsync(); }
}

<!-- ======== ROW 1: KPIs + Serie de ventas ======== -->
<div class="row">
    <div class="col-xxl-9">
        <div class="row">
            <div class="col-xl-3">
                <div class="row">
                    @foreach (var k in Kpis)
                    {
                        <div class="col-xl-12 col-md-6">
                            <div class="card custom-card dashboard-main-card overflow-hidden">
                                <div class="card-body">
                                    <div class="d-flex align-items-start gap-3">
                                        <div class="flex-fill">
                                            <span class="fs-13 fw-medium">@k.Title</span>
                                            <h4 class="fw-semibold lh-1 my-2">@k.Value</h4>
                                            <span class="badge bg-@k.BadgeClass">@k.Sub</span>
                                        </div>
                                        <div>
                                            <span class="avatar avatar-md bg-@k.SvgColor-transparent svg-@k.SvgColor">
                                                @k.IconSvg
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="col-xl-9">
                <div class="card custom-card">
                    <div class="card-header justify-content-between">
                        <div class="card-title">Ventas e Impuestos</div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn @( _bucket==TimeBucket.Day ? "btn-primary":"btn-primary-light")" @onclick="() => SetBucket(TimeBucket.Day)">Día</button>
                            <button class="btn @( _bucket==TimeBucket.Week ? "btn-primary":"btn-primary-light")" @onclick="() => SetBucket(TimeBucket.Week)">Semana</button>
                            <button class="btn @( _bucket==TimeBucket.Month ? "btn-primary":"btn-primary-light")" @onclick="() => SetBucket(TimeBucket.Month)">Mes</button>
                        </div>
                    </div>

                    <div class="card-body pt-4 pb-0">
                        <ApexChart TItem="SalesPoint" Height="350" Options="SalesOptions">
                            <ApexPointSeries TItem="SalesPoint" Items="Sales" SeriesType="@SeriesType.Bar" Name="Subtotal" XValue="@(e => e.BucketLabel)" YAggregate="@(e => e.Sum(x => x.Subtotal))" />
                            <ApexPointSeries TItem="SalesPoint" Items="Sales" SeriesType="@SeriesType.Bar" Name="IVA" XValue="@(e => e.BucketLabel)" YAggregate="@(e => e.Sum(x => x.IVA))" />
                            <ApexPointSeries TItem="SalesPoint" Items="Sales" SeriesType="@SeriesType.Line" Name="Total" XValue="@(e => e.BucketLabel)" YAggregate="@(e => e.Sum(x => x.Ventas))" />
                            <ApexPointSeries TItem="SalesPoint" Items="Sales" SeriesType="@SeriesType.Line" Name="Autorizadas" XValue="@(e => e.BucketLabel)" YAggregate="@(e => e.Sum(x => x.FacturasAut))" />
                        </ApexChart>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel derecho: Top productos y alertas -->
    <div class="col-xxl-3">
        <div class="row">
            <div class="col-xl-12">
                <div class="card custom-card">
                    <div class="card-header justify-content-between">
                        <div class="card-title">Top productos (por cantidad)</div>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            @foreach (var p in TopProductos)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>@p.Nombre</span>
                                    <span class="badge bg-primary">@p.Cantidad</span>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-xl-12">
                <div class="card custom-card">
                    <div class="card-header justify-content-between">
                        <div class="card-title">Alertas de stock</div>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            @foreach (var a in AlertasStock)
                            {
                                var danger = a.Stock <= a.Minimo;
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">@a.Nombre <span class="text-muted">(@a.Codigo)</span></div>
                                        <small class="text-muted">Mínimo: @a.Minimo</small>
                                    </div>
                                    <span class="badge @(danger ? "bg-danger" : "bg-warning")">Stock: @a.Stock</span>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ======== ROW 2: Últimas facturas ======== -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card custom-card">
            <div class="card-header justify-content-between">
                <div class="card-title">Últimas facturas</div>
                <a class="fs-12 text-muted text-decoration-underline" href="/facturas">Ver todas</a>
            </div>
            <div class="table-responsive">
                <table class="table-hover mb-0 table">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Estado SRI</th>
                            <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var f in UltimasFacturas)
                        {
                            var cls = f.EstadoSRI switch
                            {
                                "AUTORIZADA" => "badge bg-success",
                                "DEVUELTA" => "badge bg-warning",
                                "RECHAZADA" => "badge bg-danger",
                                "ENVIADA" => "badge bg-info",
                                "ANULADA" => "badge bg-secondary",
                                _ => "badge bg-light text-dark"
                            };
                            <tr>
                                <td>@f.Numero</td>
                                <td>@f.Cliente</td>
                                <td>@f.Fecha.ToString("yyyy-MM-dd")</td>
                                <td><span class="@cls">@f.EstadoSRI</span></td>
                                <td class="text-end">@FormatMoney(f.Total)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
