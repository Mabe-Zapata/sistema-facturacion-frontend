@page "/error/error404"
@inject ScriptLoaderService ScriptLoader
@inject IJSRuntime JS
@inject Microsoft.AspNetCore.Components.NavigationManager NavigationManager
@layout Components.Layout.CustomLayout
@implements IAsyncDisposable

<div class="page error-bg" style="min-height: 100vh;">
    <div class="error-page-background">
        <img src="../assets/images/media/backgrounds/10.svg" alt="">
    </div>

    <div id="particles-js"></div>
    <!-- Start::error-page -->
    <div class="row align-items-center justify-content-center h-100 g-0">
        <div class="col-xl-7 col-lg-7 col-md-7 col-12">
            <div class="text-center">
                <div class="mb-5 text-center">
                    <img src="../assets/images/media/backgrounds/11.png" alt="" class="w-sm-auto w-100 h-100">
                </div>
                <span class="d-block fs-4 text-primary fw-semibold">Página no encontrada</span>
                <p class="error-text mb-0">404</p>
                <p class="fs-5 fw-normal mb-0">
                    El recurso no existe o fue movido.<br>
                    Verifica la URL o vuelve al inicio.
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    private bool _scriptsLoaded;
    private IJSObjectReference? _particlesModule;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_scriptsLoaded)
        {
            var baseUri = NavigationManager.BaseUri;

            await ScriptLoader.LoadScriptAsync($"{baseUri}assets/js/countdown.js");

            await ScriptLoader.AddInlineScriptAsync(@"
                setTimeout(() => {
                    if (typeof updateTimer === 'function') {
                        updateTimer();
                        setInterval(updateTimer, 1000);
                    }
                }, 100);
            ");

            await Task.Delay(200);

            try
            {
                _particlesModule = await JS.InvokeAsync<IJSObjectReference>(
                    "import", $"{baseUri}assets/js/ui/effects/particles/background-vector.js");

                await _particlesModule.InvokeVoidAsync("mountParticlesBG", "particles-js");

                _scriptsLoaded = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading particles: {ex.Message}");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_particlesModule is not null)
        {
            try
            {
                await _particlesModule.InvokeVoidAsync("unmountParticlesBG", "particles-js");
                await _particlesModule.DisposeAsync();
            }
            catch { }
        }
    }
}